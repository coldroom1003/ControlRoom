<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³µê°„ ë„¤ì´ë° ë§µ</title>

<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box;font-family:'Nanum Pen Script',sans-serif;}
body{margin:0;background:#faf7f2;}

.container{
  display:grid;
  grid-template-columns:8fr 2fr;
  height:100vh;
}

.mode-badge{
  position:fixed;top:10px;left:10px;
  padding:6px 12px;background:#ffe066;
  border:2px solid #333;display:none;z-index:999;
}

/* ì´ë¯¸ì§€ ì˜ì—­ */
.image-area{
  position:relative;
  border:2px solid #444;
  background:white;
  overflow:hidden;
}

#canvas{
  width:100%;height:100%;
  background-size:contain;
  background-position:center;
  background-repeat:no-repeat;
}

.sketch-bg{
  position:absolute;inset:0;
  background:repeating-linear-gradient(
    rgba(0,0,0,0.05) 1px,
    transparent 2px,
    transparent 6px
  );
}

/* ë¼ë²¨ */
.hit-area{
  position:absolute;
  transform:translate(-50%,-50%);
}

.hit-title{
  background:#fffdf5;
  border:1px solid #333;
  padding:4px 8px;
  cursor:pointer;
}

.highlight{
  position:absolute;
  width:40px;height:26px;
  background:rgba(255,235,59,0.7);
  border-radius:50%;
  transform:translate(-50%,-50%);
  display:none;
  pointer-events:none;
}

/* ë¦¬ìŠ¤íŠ¸ */
.info-area{
  border-left:2px dashed #aaa;
  padding:10px 10px 10px 16px;
  overflow-y:auto;
}

.top-bar{
  display:flex;
  gap:6px;
  margin-bottom:8px;
  flex-wrap:wrap;
}

button{
  font-size:18px;
  cursor:pointer;
  padding:6px 10px;
}

.edit-on{background:#ff7675;color:white;}

.search{flex:1;padding:6px;}

li{
  background:#fffdf5;
  margin-bottom:8px;
  padding:8px;
  border:1px solid #ccc;
  cursor:pointer;
  position:relative;
}

.del-btn{
  position:absolute;
  right:6px;top:2px;
  color:#111;
  cursor:pointer;
}

.detail{
  display:none;
  margin-top:6px;
  border-left:4px solid #f4d03f;
  padding-left:6px;
}

/* ëª¨ë°”ì¼ */
@media(max-width:600px){
  .container{
    grid-template-columns:1fr;
    grid-template-rows:auto 1fr;
  }

  .image-area{
    height:40vh;
  }

  .info-area{
    height:60vh;
    padding-bottom:90px;
  }

  .top-bar{
    position:fixed;
    bottom:0;left:0;right:0;
    background:white;
    border-top:2px solid #ccc;
    padding:10px;
    z-index:10;
  }

  button{
    font-size:22px;
    padding:10px;
  }
}

/* ë‚´ë³´ë‚´ê¸°ì‹œ ìˆ¨ê¹€ */
.export-hide{display:none!important;}
</style>
</head>

<body>

<div id="modeBadge" class="mode-badge">âœï¸ í¸ì§‘ëª¨ë“œ</div>

<div class="container" id="captureRoot">

<div class="image-area" id="imageArea">
  <div id="canvas">
    <div class="sketch-bg"></div>
    <div id="hitAreas"></div>
    <div id="highlight" class="highlight"></div>
  </div>
</div>

<div class="info-area" id="listPanel">
  <div class="top-bar export-ui">
    <button id="editBtn">âœï¸</button>
    <button id="imgBtn">ğŸ“·</button>
    <button id="clearImgBtn">âŒ</button>
    <button id="exportBtn">ğŸ’¾</button>
    <label><input type="checkbox" id="includeList" checked>ë¦¬ìŠ¤íŠ¸</label>
    <input type="file" id="imgInput" hidden accept="image/*">
    <input id="searchBox" class="search" placeholder="ê²€ìƒ‰">
  </div>

  <ul id="itemList"></ul>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

/* Firebase */
const app=initializeApp({
 apiKey:"AIzaSyBUL...",
 authDomain:"sound-control-room.firebaseapp.com",
 projectId:"sound-control-room",
 storageBucket:"sound-control-room.firebasestorage.app"
});
const db=getFirestore(app);
const storage=getStorage(app);

const COL=collection(db,"items");
const CFG=doc(db,"config","bg");

let items=[];
let editMode=false;

const canvas=document.getElementById("canvas");
const hitWrap=document.getElementById("hitAreas");
const listEl=document.getElementById("itemList");
const highlight=document.getElementById("highlight");
const badge=document.getElementById("modeBadge");

/* í¸ì§‘ëª¨ë“œ */
editBtn.onclick=()=>{
 editMode=!editMode;
 editBtn.classList.toggle("edit-on",editMode);
 badge.style.display=editMode?"block":"none";
};

/* ë°°ê²½ ì—…ë¡œë“œ */
imgBtn.onclick=()=>{if(editMode)imgInput.click();};

imgInput.onchange=async e=>{
 if(!editMode)return;
 const file=e.target.files[0];
 const r=ref(storage,"bg.png");
 await uploadBytes(r,file);
 const url=await getDownloadURL(r);
 canvas.style.backgroundImage=`url(${url})`;
 await setDoc(CFG,{url});
};

clearImgBtn.onclick=async ()=>{
 if(!editMode)return;
 canvas.style.backgroundImage="";
 await setDoc(CFG,{url:""});
};

/* ì €ì¥ */
const save=it=>setDoc(doc(db,"items",String(it.id)),it);

function render(){renderHits();renderList();}

function renderHits(){
 hitWrap.innerHTML="";
 items.forEach(it=>{
  const d=document.createElement("div");
  d.className="hit-area";
  d.style.left=it.x+"%";
  d.style.top=it.y+"%";

  const t=document.createElement("div");
  t.className="hit-title";
  t.innerText=it.name;

  d.onclick=e=>{
   e.stopPropagation();
   highlight.style.left=it.x+"%";
   highlight.style.top=it.y+"%";
   highlight.style.display="block";
  };

  d.appendChild(t);
  hitWrap.appendChild(d);
 });
}

function renderList(){
 listEl.innerHTML="";
 const q=searchBox.value.toLowerCase();

 items.filter(i=>
  i.name.toLowerCase().includes(q) ||
  (i.desc||"").toLowerCase().includes(q)
 ).forEach(it=>{
  const li=document.createElement("li");

  const del=document.createElement("span");
  del.innerText="âœ•";
  del.className="del-btn";
  del.onclick=e=>{
   e.stopPropagation();
   if(editMode){
    deleteDoc(doc(db,"items",String(it.id)));
    items=items.filter(x=>x.id!==it.id);
    render();
   }
  };

  const title=document.createElement("div");
  title.innerText=it.name;

  const detail=document.createElement("div");
  detail.className="detail";
  detail.innerText=it.desc||"ì„¤ëª…";

  li.onclick=()=>{
   document.querySelectorAll(".detail").forEach(d=>d.style.display="none");
   detail.style.display="block";
  };

  li.append(del,title,detail);
  listEl.appendChild(li);
 });
}

/* ì¶”ê°€ */
imageArea.ondblclick=e=>{
 if(!editMode)return;
 const r=imageArea.getBoundingClientRect();
 const it={
  id:Date.now(),
  name:"ìƒˆ ë¬¼ê±´",
  x:(e.clientX-r.left)/r.width*100,
  y:(e.clientY-r.top)/r.height*100,
  desc:"ì„¤ëª…"
 };
 items.push(it);
 save(it);
 render();
};

/* ë‚´ë³´ë‚´ê¸° */
exportBtn.onclick=async ()=>{
 if(editMode){alert("ë·°ì–´ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥");return;}

 document.querySelectorAll(".export-ui")
  .forEach(x=>x.classList.add("export-hide"));

 const target=includeList.checked
  ? document.getElementById("captureRoot")
  : document.getElementById("imageArea");

 const cap=await html2canvas(target);
 const a=document.createElement("a");
 a.download="map.png";
 a.href=cap.toDataURL();
 a.click();

 document.querySelectorAll(".export-ui")
  .forEach(x=>x.classList.remove("export-hide"));
};

/* ë¡œë“œ */
(async()=>{
 const snap=await getDocs(COL);
 items=snap.docs.map(d=>d.data());
 render();

 const bg=await getDocs(collection(db,"config"));
 bg.forEach(d=>{
  const u=d.data().url;
  if(u)canvas.style.backgroundImage=`url(${u})`;
 });
})();
</script>
</body>
</html>