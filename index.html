<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
 margin:0;
 display:flex;
 height:100vh;
 font-family:sans-serif;
 background:#fdfefe;
 touch-action:none;
}

#left{flex:8;display:flex;flex-direction:column}

.tabs{
 display:flex;
 height:36px;
 background:#eef5fb;
 border-bottom:1px solid #d6e2ee;
}
.tab{
 flex:1;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 font-size:14px;
}
.tab.active{background:white;font-weight:bold}

#imageArea{
 flex:1;
 position:relative;
 background:#f7fafc;
 overflow:hidden;
}

#canvas{
 width:100%;height:100%;
 background-size:contain;
 background-position:center;
 background-repeat:no-repeat;
}

#lines{
 position:absolute;
 inset:0;
 pointer-events:none;
}

.hit{
 position:absolute;
 transform:translate(-50%,-50%);
 background:#fffef9;
 border:1px solid #c9d6e2;
 padding:6px 10px;
 border-radius:12px;
 cursor:pointer;
}
.hit.active{
 background:#e8f4ff;
 box-shadow:0 0 0 2px #9ed0ff;
}

#side{
 flex:2;
 border-left:1px solid #d6e2ee;
 display:flex;
 flex-direction:column;
}

#search{padding:8px;border:none;border-bottom:1px solid #ddd}

ul{list-style:none;margin:0;padding:0;flex:1;overflow:auto}
li{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
li.active{background:#eaf4ff}

.detail{font-size:13px;display:none;margin-top:4px}
.del{float:right;cursor:pointer}

#bar{
 position:fixed;
 bottom:10px;
 left:10px;
 background:white;
 padding:8px;
 border-radius:12px;
 box-shadow:0 2px 6px rgba(0,0,0,.12);
}

button{
 margin:2px;
 background:linear-gradient(145deg,#d7ecff,#b8dbff);
 border:none;
 padding:6px 12px;
 border-radius:8px;
 cursor:pointer;
}
.edit-on{background:#7fc3ff}
</style>
</head>

<body>

<div id="left">
 <div class="tabs">
  <div id="tabMy" class="tab active">내 작업</div>
  <div id="tabTpl" class="tab">템플릿</div>
 </div>

 <div id="imageArea">
  <div id="canvas"></div>
  <svg id="lines"></svg>
  <div id="hits"></div>
 </div>
</div>

<div id="side">
 <input id="search" placeholder="검색...">
 <ul id="list"></ul>
</div>

<div id="bar">
 <button id="editBtn">편집</button>
 <button id="alignH">가로정렬</button>
 <button id="alignV">세로정렬</button>
 <button id="bgBtn">배경</button>
 <button id="pngBtn">PNG</button>
 <button id="jsonOut">JSON↓</button>
 <button id="jsonIn">JSON↑</button>

 <input type="file" id="bgInput" hidden accept="image/*">
 <input type="file" id="jsonFile" hidden accept=".json">
</div>

<script>
let myData=JSON.parse(localStorage.getItem("myData")||"[]");
let tplData=[];
let items=myData;

let edit=false;
let selected=null;
let multiSelect=[];
let drag=null;
let mode="my";
let searchText="";

const hits=document.getElementById("hits");
const lines=document.getElementById("lines");
const imageArea=document.getElementById("imageArea");

function save(){localStorage.setItem("myData",JSON.stringify(myData));}

/* ===== 드래그 (터치+펜슬 지원) ===== */
function startDrag(e,it){
 if(!edit||mode!=="my")return;
 drag=it;
}
function moveDrag(e){
 if(!drag)return;
 let t=e.touches?e.touches[0]:e;
 const r=imageArea.getBoundingClientRect();
 drag.x=(t.clientX-r.left)/r.width*100;
 drag.y=(t.clientY-r.top)/r.height*100;
 save();render();
}
function endDrag(){drag=null;}

document.addEventListener("mousemove",moveDrag);
document.addEventListener("mouseup",endDrag);
document.addEventListener("touchmove",moveDrag,{passive:false});
document.addEventListener("touchend",endDrag);

/* ===== 정렬 ===== */
alignH.onclick=()=>{
 if(multiSelect.length<2)return;
 let avg=multiSelect.reduce((a,b)=>a+b.y,0)/multiSelect.length;
 multiSelect.forEach(it=>it.y=avg);
 save();render();
};

alignV.onclick=()=>{
 if(multiSelect.length<2)return;
 let avg=multiSelect.reduce((a,b)=>a+b.x,0)/multiSelect.length;
 multiSelect.forEach(it=>it.x=avg);
 save();render();
};

/* ===== 렌더 ===== */
function render(){
 hits.innerHTML="";
 lines.innerHTML="";

 items.forEach(it=>{
  const hx=it.lx??it.x;
  const hy=it.ly??it.y;

  if(it.lx!==null){
   const path=document.createElementNS("http://www.w3.org/2000/svg","path");
   const sx=it.x/100*imageArea.clientWidth;
   const sy=it.y/100*imageArea.clientHeight;
   const ex=it.lx/100*imageArea.clientWidth;
   const ey=it.ly/100*imageArea.clientHeight;
   const cx=(sx+ex)/2;
   path.setAttribute("d",`M${sx},${sy} Q${cx},${sy} ${ex},${ey}`);
   path.setAttribute("stroke","#444");
   path.setAttribute("fill","none");
   path.setAttribute("marker-end","url(#arrow)");
   lines.appendChild(path);
  }

  const d=document.createElement("div");
  d.className="hit"+(it.id===selected?" active":"");
  d.style.left=hx+"%";
  d.style.top=hy+"%";
  d.textContent=it.name;

  d.onpointerdown=e=>startDrag(e,it);

  d.onclick=e=>{
   e.stopPropagation();
   if(edit){
    if(!multiSelect.includes(it)) multiSelect.push(it);
    else multiSelect=multiSelect.filter(x=>x!==it);
   }else selected=it.id;
   render();
  };

  hits.appendChild(d);
 });
}

/* ===== SVG 화살촉 정의 ===== */
lines.innerHTML=`
<defs>
<marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
<path d="M0,0 L0,6 L6,3 z" fill="#444"/>
</marker>
</defs>
`;

render();
</script>

</body>
</html>