<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³µê°„ ë„¤ì´ë° ë§µ</title>

<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box;font-family:'Nanum Pen Script',sans-serif;}
body{margin:0;background:#faf7f2;}

.container{
 display:grid;
 grid-template-columns:8fr 2fr;
 height:100vh;
}

/* ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¹€ */
.container.hide-list{
 grid-template-columns:1fr;
}
.container.hide-list .info-area{
 display:none;
}

/* ì´ë¯¸ì§€ */
.image-area{
 position:relative;
 border:2px solid #444;
 background:white;
 overflow:hidden;
}

#canvas{
 width:100%;height:100%;
 background-position:center;
 background-repeat:no-repeat;
 background-size:contain;
}

.hit-area{
 position:absolute;
 transform:translate(-50%,-50%);
}

.hit-title{
 background:#fff;
 border:1px solid #333;
 padding:4px 8px;
 cursor:pointer;
}

.highlight{
 position:absolute;
 width:40px;height:26px;
 background:rgba(255,235,59,.7);
 border-radius:50%;
 display:none;
 transform:translate(-50%,-50%);
}

.info-area{
 border-left:2px dashed #aaa;
 padding:10px 10px 10px 16px;
 overflow-y:auto;
}

.top-bar{
 display:flex;
 gap:6px;
 flex-wrap:wrap;
}

button{font-size:18px;padding:6px;}

li{
 background:#fff;
 margin-bottom:8px;
 padding:8px;
 position:relative;
 cursor:pointer;
}

.del-btn{
 position:absolute;
 right:6px;top:4px;
 cursor:pointer;
}

.detail{
 display:none;
 border-left:4px solid #f4d03f;
 padding-left:6px;
 margin-top:6px;
}

/* ëª¨ë°”ì¼ */
@media (max-width:900px) and (orientation:portrait){
 .container{
  grid-template-columns:1fr;
  grid-template-rows:45vh 1fr;
 }
 .image-area{height:45vh;}
}
</style>
</head>

<body>

<div class="container" id="wrap">

<div class="image-area" id="imageArea">
 <div id="canvas">
  <div id="hitAreas"></div>
  <div id="highlight" class="highlight"></div>
 </div>
</div>

<div class="info-area">
 <div class="top-bar">
  <button id="editBtn">âœï¸</button>
  <button id="imgBtn">ğŸ“·</button>
  <button id="toggleListBtn">â˜°</button>
  <button id="exportBtn">ğŸ’¾</button>
  <input id="searchBox" placeholder="ê²€ìƒ‰">
  <input type="file" id="imgInput" hidden accept="image/*">
 </div>
 <ul id="itemList"></ul>
</div>

</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {getFirestore,collection,getDocs,setDoc,doc,deleteDoc}
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import {getStorage,ref,uploadBytes,getDownloadURL}
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

const app=initializeApp({
 apiKey:"AIzaSyBUL...",
 authDomain:"sound-control-room.firebaseapp.com",
 projectId:"sound-control-room",
 storageBucket:"sound-control-room.firebasestorage.app"
});
const db=getFirestore(app);
const storage=getStorage(app);

let items=[];
let editMode=false;

const canvas=document.getElementById("canvas");
const hitWrap=document.getElementById("hitAreas");
const listEl=document.getElementById("itemList");
const highlight=document.getElementById("highlight");

editBtn.onclick=()=>editMode=!editMode;

/* ë¦¬ìŠ¤íŠ¸ ì ‘ê¸° */
toggleListBtn.onclick=()=>{
 document.getElementById("wrap").classList.toggle("hide-list");
};

/* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
imgBtn.onclick=()=>{if(editMode)imgInput.click();};

imgInput.onchange=async e=>{
 if(!editMode)return;
 const file=e.target.files[0];
 const r=ref(storage,"bg");
 await uploadBytes(r,file);
 const url=await getDownloadURL(r);

 canvas.style.backgroundImage=`url(${url})`; // ì¦‰ì‹œ ë°˜ì˜
 await setDoc(doc(db,"config","bg"),{url});
};

/* ë¡±í”„ë ˆìŠ¤ ì¶”ê°€ */
let pressTimer=null;
imageArea.addEventListener("touchstart",e=>{
 if(!editMode)return;
 const t=e.touches[0];
 pressTimer=setTimeout(()=>{
  const r=imageArea.getBoundingClientRect();
  addItem((t.clientX-r.left)/r.width*100,(t.clientY-r.top)/r.height*100);
 },3000);
});
imageArea.addEventListener("touchend",()=>clearTimeout(pressTimer));

/* ë”ë¸”í´ë¦­ ì¶”ê°€(PC) */
imageArea.ondblclick=e=>{
 if(!editMode)return;
 const r=imageArea.getBoundingClientRect();
 addItem((e.clientX-r.left)/r.width*100,(e.clientY-r.top)/r.height*100);
};

function addItem(x,y){
 const it={id:Date.now(),name:"ìƒˆ ë¬¼ê±´",x,y,desc:"ì„¤ëª…"};
 items.push(it);
 setDoc(doc(db,"items",String(it.id)),it);
 render();
}

function render(){
 hitWrap.innerHTML="";
 listEl.innerHTML="";
 items.forEach(it=>{
  const d=document.createElement("div");
  d.className="hit-area";
  d.style.left=it.x+"%";
  d.style.top=it.y+"%";
  d.innerHTML=`<div class="hit-title">${it.name}</div>`;
  d.onclick=()=>{
   highlight.style.left=it.x+"%";
   highlight.style.top=it.y+"%";
   highlight.style.display="block";
  };
  hitWrap.appendChild(d);

  const li=document.createElement("li");
  li.innerHTML=`<span class="del-btn">âœ•</span>${it.name}
   <div class="detail">${it.desc}</div>`;
  li.onclick=()=>{
   document.querySelectorAll(".detail").forEach(d=>d.style.display="none");
   li.querySelector(".detail").style.display="block";
  };
  li.querySelector(".del-btn").onclick=e=>{
   e.stopPropagation();
   if(editMode){
    deleteDoc(doc(db,"items",String(it.id)));
    items=items.filter(x=>x.id!==it.id);
    render();
   }
  };
  listEl.appendChild(li);
 });
}

/* ë‚´ë³´ë‚´ê¸° */
exportBtn.onclick=async ()=>{
 if(editMode)return alert("ë·°ì–´ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥");
 const cap=await html2canvas(document.getElementById("wrap"));
 const a=document.createElement("a");
 a.href=cap.toDataURL();
 a.download="map.png";
 a.click();
};

/* ë¡œë“œ */
(async()=>{
 const s=await getDocs(collection(db,"items"));
 items=s.docs.map(d=>d.data());
 render();

 const bg=await getDocs(collection(db,"config"));
 bg.forEach(d=>{
  if(d.data().url)canvas.style.backgroundImage=`url(${d.data().url})`;
 });
})();
</script>
</body>
</html>