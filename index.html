<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
 margin:0;
 display:flex;
 height:100vh;
 font-family:sans-serif;
 background:#fdfefe;
}

#left{flex:8;display:flex;flex-direction:column}

.tabs{
 display:flex;
 height:36px;
 background:#eef5fb;
 border-bottom:1px solid #d6e2ee;
}
.tab{
 flex:1;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 font-size:14px;
 color:#4a5a6a;
}
.tab.active{background:white;font-weight:bold}

#imageArea{
 flex:1;
 position:relative;
 background:#f7fafc;
 overflow:hidden;
 touch-action:none;
}

#canvas{
 width:100%;height:100%;
 background-size:contain;
 background-position:center;
 background-repeat:no-repeat;
}

#lines{
 position:absolute;
 inset:0;
 pointer-events:none;
}

.hit{
 position:absolute;
 transform:translate(-50%,-50%);
 background:#fffef9;
 border:1px solid #c9d6e2;
 padding:5px 9px;
 border-radius:10px;
 cursor:pointer;
 color:#3c4b5a;
}
.hit.transparent{
 background:transparent;
 border-style:dashed;
}
.hit.active{background:#e8f4ff}

.handle{
 position:absolute;
 width:14px;height:14px;
 border-radius:50%;
 background:white;
 border:2px solid #4a90e2;
 transform:translate(-50%,-50%);
 cursor:pointer;
}

#side{
 flex:2;
 border-left:1px solid #d6e2ee;
 display:flex;
 flex-direction:column;
 background:#f9fcff;
}

#search{
 padding:8px;
 border:none;
 border-bottom:1px solid #dde7f0;
 outline:none;
}

ul{list-style:none;margin:0;padding:0;flex:1;overflow:auto}
li{padding:8px;border-bottom:1px solid #eef2f6;cursor:pointer}
li.active{background:#eaf4ff}

.detail{
 font-size:13px;
 color:#6a7a8a;
 display:none;
 margin-top:4px;
}

.del{float:right;cursor:pointer}

#bar{
 position:fixed;
 bottom:10px;
 left:10px;
 background:white;
 padding:8px;
 border-radius:12px;
 box-shadow:0 2px 6px rgba(0,0,0,.12);
}

button{
 margin:2px;
 background:linear-gradient(145deg,#d7ecff,#b8dbff);
 border:none;
 padding:6px 12px;
 border-radius:8px;
 cursor:pointer;
}
.edit-on{
 background:linear-gradient(145deg,#a8d8ff,#7fc3ff);
}
</style>
</head>

<body>

<div id="left">
 <div class="tabs">
  <div id="tabMy" class="tab active">ë‚´ ì‘ì—…</div>
  <div id="tabTpl" class="tab">í…œí”Œë¦¿</div>
 </div>

 <div id="imageArea">
  <div id="canvas"></div>
  <svg id="lines"></svg>
  <div id="hits"></div>
 </div>
</div>

<div id="side">
 <input id="search" placeholder="ê²€ìƒ‰...">
 <ul id="list"></ul>
</div>

<div id="bar">
 <button id="editBtn">í¸ì§‘</button>
 <button id="bgBtn">ë°°ê²½</button>
 <button id="pngBtn">PNG</button>
 <button id="jsonOut">JSONâ†“</button>
 <button id="jsonIn">JSONâ†‘</button>
 <label><input type="checkbox" id="transChk">íˆ¬ëª…</label>

 <input type="file" id="bgInput" hidden accept="image/*">
 <input type="file" id="jsonFile" hidden accept=".json">
</div>

<script>
let myData=JSON.parse(localStorage.getItem("myData")||"[]");
let tplData=[];
let items=myData;

let edit=false;
let selected=null;
let mode="my";
let searchText="";

const hits=document.getElementById("hits");
const list=document.getElementById("list");
const canvas=document.getElementById("canvas");
const search=document.getElementById("search");
const imageArea=document.getElementById("imageArea");
const lines=document.getElementById("lines");

const editBtn=document.getElementById("editBtn");
const bgBtn=document.getElementById("bgBtn");
const pngBtn=document.getElementById("pngBtn");
const jsonOut=document.getElementById("jsonOut");
const jsonIn=document.getElementById("jsonIn");
const transChk=document.getElementById("transChk");

const bgInput=document.getElementById("bgInput");
const jsonFile=document.getElementById("jsonFile");

/* íƒ­ */
tabMy.onclick=()=>{mode="my";items=myData;tabMy.classList.add("active");tabTpl.classList.remove("active");render();}
tabTpl.onclick=()=>{mode="tpl";items=tplData;tabTpl.classList.add("active");tabMy.classList.remove("active");render();}

/* í¸ì§‘ */
editBtn.onclick=()=>{edit=!edit;editBtn.classList.toggle("edit-on",edit);}

/* ê²€ìƒ‰ */
search.oninput=e=>{searchText=e.target.value.toLowerCase();render();}

/* ì €ì¥ */
function save(){localStorage.setItem("myData",JSON.stringify(myData));}
function remove(id){myData=myData.filter(x=>x.id!==id);items=myData;save();render();}

/* ===== í„°ì¹˜ 1íšŒ ì¶”ê°€ ===== */
let lastTap=0;

imageArea.onpointerdown=e=>{
 if(!edit||mode!=="my")return;
 if(e.target.classList.contains("hit")||e.target.classList.contains("handle"))return;

 const r=imageArea.getBoundingClientRect();

 // ğŸ“± í„°ì¹˜ë©´ ì¦‰ì‹œ ì¶”ê°€
 if(e.pointerType==="touch"){
  myData.push({
   id:Date.now(),
   name:"í•­ëª©",
   desc:"ì„¤ëª…",
   x:(e.clientX-r.left)/r.width*100,
   y:(e.clientY-r.top)/r.height*100,
   lx:null,ly:null,
   transparent:false
  });
  save();render();
  return;
 }

 // ğŸ’» PCëŠ” ë”ë¸”íƒ­ ìœ ì§€
 const now=Date.now();
 if(now-lastTap<300){
  myData.push({
   id:Date.now(),
   name:"í•­ëª©",
   desc:"ì„¤ëª…",
   x:(e.clientX-r.left)/r.width*100,
   y:(e.clientY-r.top)/r.height*100,
   lx:null,ly:null,
   transparent:false
  });
  save();render();
 }
 lastTap=now;
};

/* ë“œë˜ê·¸ */
let dragItem=null;
let dragType=null;

document.addEventListener("pointermove",e=>{
 if(!dragItem)return;
 const r=imageArea.getBoundingClientRect();
 const x=(e.clientX-r.left)/r.width*100;
 const y=(e.clientY-r.top)/r.height*100;

 if(dragType==="item"){
  if(dragItem.lx!==null){dragItem.lx=x;dragItem.ly=y;}
  else{dragItem.x=x;dragItem.y=y;}
 }
 if(dragType==="end"){dragItem.lx=x;dragItem.ly=y;}
 if(dragType==="start"){dragItem.x=x;dragItem.y=y;}

 save();render();
});
document.addEventListener("pointerup",()=>dragItem=null);

/* ë Œë” */
function render(){
 hits.innerHTML="";
 list.innerHTML="";
 lines.innerHTML="";
 lines.setAttribute("width",imageArea.clientWidth);
 lines.setAttribute("height",imageArea.clientHeight);

 let filtered=items.filter(it=>
  it.name.toLowerCase().includes(searchText)||
  it.desc.toLowerCase().includes(searchText)
 );

 filtered.forEach(it=>{
  const hx=it.lx??it.x;
  const hy=it.ly??it.y;

  if(it.lx!==null){
   const line=document.createElementNS("http://www.w3.org/2000/svg","line");
   line.setAttribute("x1",it.x/100*imageArea.clientWidth);
   line.setAttribute("y1",it.y/100*imageArea.clientHeight);
   line.setAttribute("x2",it.lx/100*imageArea.clientWidth);
   line.setAttribute("y2",it.ly/100*imageArea.clientHeight);
   line.setAttribute("stroke","#444");
   line.setAttribute("stroke-width","2");
   lines.appendChild(line);
  }

  const d=document.createElement("div");
  d.className="hit"+(it.id===selected?" active":"")+(it.transparent?" transparent":"");
  d.style.left=hx+"%";
  d.style.top=hy+"%";
  d.textContent=it.name;

  /* ğŸ“± ë¡±í”„ë ˆìŠ¤ í™”ì‚´í‘œ */
  let pressTimer=null;
  d.onpointerdown=e=>{
   if(edit&&mode==="my"){
    dragItem=it;dragType="item";
    d.setPointerCapture(e.pointerId);

    if(e.pointerType==="touch"){
     pressTimer=setTimeout(()=>{
      if(it.lx===null){it.lx=it.x+10;it.ly=it.y+10;}
      else{it.lx=null;it.ly=null;}
      save();render();
     },500);
    }
   }
  };

  d.onpointerup=()=>{clearTimeout(pressTimer);}

  /* ğŸ’» PC ë”ë¸”í´ë¦­ ìœ ì§€ */
  d.ondblclick=e=>{
   if(edit&&mode==="my"){
    if(it.lx===null){it.lx=it.x+10;it.ly=it.y+10;}
    else{it.lx=null;it.ly=null;}
    save();render();
   }
   e.stopPropagation();
  };

  d.onclick=e=>{
   e.stopPropagation();
   selected=it.id;
   render();
  };

  hits.appendChild(d);

  /* ë¦¬ìŠ¤íŠ¸ */
  const li=document.createElement("li");
  if(it.id===selected) li.className="active";

  const del=document.createElement("span");
  del.className="del";
  del.textContent="âœ•";
  del.onclick=e=>{e.stopPropagation();if(edit&&mode==="my")remove(it.id);};

  const t=document.createElement("div");t.textContent=it.name;
  const det=document.createElement("div");
  det.className="detail";
  det.textContent=it.desc;
  if(it.id===selected) det.style.display="block";

  li.onclick=()=>{selected=it.id;render();};

  li.appendChild(del);
  li.appendChild(t);
  li.appendChild(det);
  list.appendChild(li);
 });
}

/* PNG */
pngBtn.onclick=()=>{
 html2canvas(imageArea).then(c=>{
  const a=document.createElement("a");
  a.href=c.toDataURL();
  a.download="map.png";
  a.click();
 });
};

/* JSON */
jsonOut.onclick=()=>{
 const blob=new Blob([JSON.stringify(myData)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="map.json";
 a.click();
};

jsonIn.onclick=()=>jsonFile.click();
jsonFile.onchange=e=>{
 const f=e.target.files[0];
 const r=new FileReader();
 r.onload=()=>{
  tplData=JSON.parse(r.result);
  mode="tpl";
  tabTpl.classList.add("active");
  tabMy.classList.remove("active");
  items=tplData;
  render();
 };
 r.readAsText(f);
};

render();
</script>

</body>
</html>