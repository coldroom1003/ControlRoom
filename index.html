<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³µê°„ ë„¤ì´ë° ë§µ</title>

<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Nanum Pen Script',sans-serif;}
body{margin:0;background:#faf7f2;}

.container{
  display:grid;
  grid-template-columns:7fr 3fr;
  height:100vh;
}

/* í¸ì§‘ëª¨ë“œ ë°°ì§€ */
.mode-badge{
  position:fixed;
  top:10px;left:10px;
  padding:6px 12px;
  background:#ffe066;
  border:2px solid #333;
  z-index:999;
  display:none;
}

/* ê·¸ë¦¼ */
.image-area{
  position:relative;
  border:2px solid #444;
  background:white;
}

.sketch-bg{
  position:absolute;inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,0.05),
    rgba(0,0,0,0.05) 1px,
    transparent 2px,
    transparent 6px
  );
}

.hit-area{
  position:absolute;
  transform:translate(-50%,-50%);
}

.hit-title{
  background:#fffdf5;
  border:1px solid #333;
  padding:4px 8px;
  cursor:pointer;
}

/* í•˜ì´ë¼ì´íŠ¸ */
.highlight{
  position:absolute;
  width:40px;height:26px;
  background:rgba(255,235,59,0.7);
  border-radius:50%;
  transform:translate(-50%,-50%);
  display:none;
}

/* íŒ¨ë„ */
.info-area{
  border-left:2px dashed #aaa;
  padding:10px;
  overflow-y:auto;
}

.top-bar{display:flex;gap:6px;margin-bottom:8px;}

button{font-size:18px;cursor:pointer;}
.edit-on{background:#ff7675;color:white;}

.search{flex:1;padding:6px;}

li{
  background:#fffdf5;
  margin-bottom:8px;
  padding:8px;
  border:1px solid #ccc;
  cursor:pointer;
}

.detail{
  display:none;
  margin-top:6px;
  border-left:4px solid #f4d03f;
  padding-left:6px;
}

.del-btn{float:right;cursor:pointer;}

/* ëª¨ë°”ì¼ */
@media (max-width:768px){
  .container{display:flex;flex-direction:column;}
  .image-area{height:60vh;}
}
</style>
</head>

<body>

<div id="modeBadge" class="mode-badge">âœï¸ í¸ì§‘ëª¨ë“œ</div>

<div class="container">

  <div class="image-area" id="imageArea">
    <div class="sketch-bg"></div>
    <div id="hitAreas"></div>
    <div id="highlight" class="highlight"></div>
  </div>

  <div class="info-area">
    <div class="top-bar">
      <button id="editBtn">âœï¸ í¸ì§‘</button>
      <input id="searchBox" class="search" placeholder="ê²€ìƒ‰">
    </div>
    <ul id="itemList"></ul>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* Firebase */
const app=initializeApp({
  apiKey:"AIzaSyBULBV1bGrUBPE_vi0jGJWsOI1jOh-t1dE",
  authDomain:"sound-control-room.firebaseapp.com",
  projectId:"sound-control-room"
});
const db=getFirestore(app);
const COL=collection(db,"items");

/* ìƒíƒœ */
let items=[];
let editMode=false;

const imageArea=document.getElementById("imageArea");
const hitWrap=document.getElementById("hitAreas");
const listEl=document.getElementById("itemList");
const highlight=document.getElementById("highlight");
const badge=document.getElementById("modeBadge");
const editBtn=document.getElementById("editBtn");
const searchBox=document.getElementById("searchBox");

/* í¸ì§‘ëª¨ë“œ */
editBtn.onclick=()=>{
  editMode=!editMode;
  editBtn.classList.toggle("edit-on",editMode);
  badge.style.display=editMode?"block":"none";
};

/* ì €ì¥ */
const save=it=>setDoc(doc(db,"items",String(it.id)),it);

/* ì‚­ì œ */
async function remove(id){
  await deleteDoc(doc(db,"items",String(id)));
  items=items.filter(i=>i.id!==id);
  render();
}

/* ìˆ˜ì • helper */
function makeEditable(el,onSave){
  el.contentEditable=true;
  el.focus();
  el.onblur=()=>{
    el.contentEditable=false;
    onSave(el.innerText);
  };
}

/* ë Œë” */
function render(){
  renderHits();
  renderList();
}

/* ë¼ë²¨ */
function renderHits(){
  hitWrap.innerHTML="";
  items.forEach(it=>{
    const d=document.createElement("div");
    d.className="hit-area";
    d.style.left=it.x+"%";
    d.style.top=it.y+"%";

    const t=document.createElement("div");
    t.className="hit-title";
    t.innerText=it.name||"ì´ë¦„";

    /* ë¼ë²¨ ì´ë¦„ ìˆ˜ì • */
    t.ondblclick=e=>{
      if(!editMode)return;
      e.stopPropagation();
      makeEditable(t,v=>{
        it.name=v||"ì´ë¦„";
        save(it);
        render();
      });
    };

    d.onclick=e=>{
      e.stopPropagation();
      if(!editMode)select(it);
    };

    enableDrag(d,it);
    d.appendChild(t);
    hitWrap.appendChild(d);
  });
}

/* ë¦¬ìŠ¤íŠ¸ */
function renderList(){
  listEl.innerHTML="";

  const q=(searchBox.value||"").toLowerCase();

  const filtered=q
    ? items.filter(i=>(i.name||"").toLowerCase().includes(q))
    : items;

  filtered.forEach(it=>{
    const li=document.createElement("li");

    /* ì‚­ì œ */
    const del=document.createElement("span");
    del.innerText="ğŸ—‘";
    del.className="del-btn";
    del.onclick=e=>{
      e.stopPropagation();
      if(editMode)remove(it.id);
    };

    /* ì œëª© */
    const title=document.createElement("div");
    title.innerText=it.name||"ì´ë¦„";

    title.ondblclick=e=>{
      if(!editMode)return;
      makeEditable(title,v=>{
        it.name=v;
        save(it);
        render();
      });
    };

    /* ë¶€ê°€ì„¤ëª… */
    const detail=document.createElement("div");
    detail.className="detail";
    detail.innerText=it.desc||"ë¶€ê°€ ì„¤ëª…";

    /* ì„¤ëª… ìˆ˜ì • */
    detail.ondblclick=e=>{
      if(!editMode)return;
      makeEditable(detail,v=>{
        it.desc=v;
        save(it);
      });
    };

    /* í† ê¸€ ì—´ê¸°/ë‹«ê¸° */
    li.onclick=()=>{
      if(editMode)return;

      const open = detail.style.display==="block";
      document.querySelectorAll(".detail")
        .forEach(d=>d.style.display="none");

      detail.style.display=open?"none":"block";
      select(it);
    };

    li.append(del,title,detail);
    listEl.appendChild(li);
  });
}

/* ì„ íƒ */
function select(it){
  highlight.style.left=it.x+"%";
  highlight.style.top=it.y+"%";
  highlight.style.display="block";
}

/* ë“œë˜ê·¸ */
function enableDrag(el,it){
  let drag=false;
  el.onmousedown=()=>{if(editMode)drag=true;};
  window.onmousemove=e=>{
    if(!drag)return;
    const r=imageArea.getBoundingClientRect();
    it.x=(e.clientX-r.left)/r.width*100;
    it.y=(e.clientY-r.top)/r.height*100;
    el.style.left=it.x+"%";
    el.style.top=it.y+"%";
  };
  window.onmouseup=()=>{
    if(drag)save(it);
    drag=false;
  };
}

/* ë”ë¸”í´ë¦­ ì¶”ê°€ */
imageArea.ondblclick=e=>{
  if(!editMode)return;

  const r=imageArea.getBoundingClientRect();

  const it={
    id:Date.now(),
    name:"ìƒˆ ë¬¼ê±´",
    x:(e.clientX-r.left)/r.width*100,
    y:(e.clientY-r.top)/r.height*100,
    desc:"ë¶€ê°€ ì„¤ëª…"
  };

  items.push(it);
  save(it);
  render();
};

/* ê²€ìƒ‰ */
searchBox.oninput=renderList;

/* ë¹ˆê³µê°„ ì„ íƒ í•´ì œ */
imageArea.onclick=e=>{
  if(editMode)return;
  if(!e.target.closest(".hit-area")){
    highlight.style.display="none";
    document.querySelectorAll(".detail")
      .forEach(d=>d.style.display="none");
  }
};

/* Firestore ë¡œë“œ */
getDocs(COL).then(s=>{
  items=s.docs.map(d=>d.data());
  if(items.length===0){
    items=[{id:1,name:"ì˜ˆì‹œ",x:50,y:50,desc:"ì„¤ëª…"}];
  }
  render();
});
</script>

</body>
</html>