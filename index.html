<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playwrite+NZ+Basic:wght@100..400&display=swap" rel="stylesheet">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker ë“±ë¡ë¨'))
    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨', err));
}
</script>
<style>

/* ì „ì²´ í…ìŠ¤íŠ¸ì— í°íŠ¸ ì ìš© */
body, .hit, li, input, button {
  font-family: "Playwrite NZ Basic", cursive;
}
body{margin:0;display:flex;height:calc(100vh - 12px);background:#fdfefe;padding: 6px;}
#left{flex:8;display:flex;flex-direction:column}
.tabs{display:flex;height:36px;background:white;border-bottom:1px solid #d6e2ee;gap: 1px;}
.tab{flex:1;display:flex;align-items:center;justify-content:flex-start;max-width: 80px; padding: 0 16px; background-color: whitesmoke; border:1px solid #d6e2ee; border-bottom: 0; border-top-right-radius: 10px; cursor:pointer;}
.tab:first-child{border-right: 0;}
.tab.active{background:#eef5fb;font-weight:bold}
#imageArea{
  flex:1;
  position:relative;
  background:#f7fafc;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  height: 100vh;
}

#canvas {
  position:absolute;
  inset:0;
  background-position:center;
  background-repeat:no-repeat;
  background-size:contain;
  transform-origin: center center; /* â­ ì¤‘ìš” */
}

#lines{position:absolute;inset:0;pointer-events:none;}
.hit{position:absolute;transform:translate(-50%,-50%);background:#fff;border:1px solid #c9d6e2;padding:3px 6px;border-radius:6px; font-size: 14px; cursor:pointer;}
.hit.active{background:#e8f4ff;}
.handle{position:absolute;width:8px;height:8px;border-radius:50%;background:#4a90e2;transform:translate(-50%,-50%);cursor:pointer;}
#side{flex:2;margin-top: 36px;border-left:1px solid #d6e2ee;display:flex;flex-direction:column;border-top:1px solid #dde7f0;}
.searchWrap {position: relative; width: calc(100% - 16px); height: 36px;}
#search{width:100%; height: 36px; padding:0 8px;border:none;}
ul{list-style:none;margin:0;padding:0;flex:1;overflow:auto;border-top:1px solid #dde7f0;}
li{padding:12px 8px;border-bottom:1px solid #eef2f6;cursor:pointer;position:relative;}
li.active{background:#eaf4ff}
.detail{display:none;font-size:13px;color:#666;margin-top:4px}
.del{
 position:absolute;
 right:8px;
 top:10px;
 color:#c33;
 cursor:pointer;
 font-weight:bold;
 z-index:2;
 padding:4px;
 line-height:1;
}
li > div:first-child {
  display: inline-block;
  max-width: calc(100% - 40px); /* ì‚­ì œ ë²„íŠ¼ ì˜ì—­ ì œì™¸ */
}

#bar{
  position:fixed;
  bottom:env(safe-area-inset-bottom, 10px);
  left:10px;
  right:10px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
  align-items: center;
}

button{margin:2px;padding:6px 12px;border-radius:8px;border:none;cursor:pointer;}
.edit-on{background:#a8d8ff;}
#clearSearch{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  color:#999;
  font-weight:bold;
  display:none;
}

#clearSearch:hover{
  color:#333;
}
.colorPicker {border: 0; border-radius: 8px;}
</style>
</head>
<body>

<div id="left">
<div class="tabs">
<div id="tabMy" class="tab active">ë‚´ ì‘ì—…</div>
<div id="tabTpl" class="tab">í…œí”Œë¦¿</div>
</div>

<div id="imageArea">
<div id="canvas"></div>
<svg id="lines"></svg>
<div id="hits"></div>
</div>
</div>

<div id="side">
<div class="searchWrap">
  <input id="search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
  <span id="clearSearch">âœ•</span>
</div>
<ul id="list"></ul>
</div>

<div id="bar">
<button id="editBtn">í¸ì§‘</button>
<button id="bgBtn">ë°°ê²½</button>
<button id="linkBtn">í•¸ë“¤</button>
<input type="color"  class="colorPicker" id="handleColorPicker" value="#4a90e2" style="display:none;">
<button id="pngBtn">PNG</button>
<button id="jsonOut">ê³µìœ ì €ì¥</button>
<button id="jsonIn">ê³µìœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
<input type="file" id="bgInput" hidden accept="image/*">
<input type="file" id="jsonFile" hidden accept=".json">
<input
  type="range"
  id="bgScale"
  min="0.2"
  max="2"
  step="0.01"
  value="1"
  style="display:none;"
>

</div>

<script>
let myData=JSON.parse(localStorage.getItem("myData")||"[]");
let tplData=[];
let items=myData;

let edit=false, selected=null, mode="my", searchText="";
let showLinks = true; // â† ì„  + í¬ì¸íŠ¸í•¸ë“¤ í‘œì‹œ ì—¬ë¶€
const hits=document.getElementById("hits");
const list=document.getElementById("list");
const canvas=document.getElementById("canvas");
const lines=document.getElementById("lines");
const imageArea=document.getElementById("imageArea");
const editBtn=document.getElementById("editBtn");
const linkBtn = document.getElementById("linkBtn");
const bgBtn=document.getElementById("bgBtn");
const pngBtn=document.getElementById("pngBtn");
const jsonOut=document.getElementById("jsonOut");
const jsonIn=document.getElementById("jsonIn");
const bgInput=document.getElementById("bgInput");
const jsonFile=document.getElementById("jsonFile");
const search=document.getElementById("search");
const clearSearch = document.getElementById("clearSearch");
const handleColorPicker = document.getElementById("handleColorPicker");
let handleColor = localStorage.getItem("handleColor") || "#4a90e2";
handleColorPicker.value = handleColor; // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
let bgScale = Number(localStorage.getItem("bgScale") || 1);




/* í¬ì¸íŠ¸ë¼ì¸ìƒì„± */ 

linkBtn.onclick = () => {
  showLinks = !showLinks;
  linkBtn.textContent = showLinks ? "ë¼ì¸ ìˆ¨ê¹€" : "ë¼ì¸ í‘œì‹œ";
  render();
};

/* íƒ­ */
tabMy.onclick=()=>{mode="my";items=myData;tabMy.classList.add("active"); tabTpl.classList.remove("active"); render();}
tabTpl.onclick=()=>{mode="tpl";items=tplData;tabTpl.classList.add("active"); tabMy.classList.remove("active"); render();}

/* í¸ì§‘ */
const bgScaleInput = document.getElementById("bgScale");

editBtn.onclick = () => {
  edit = !edit;
  editBtn.classList.toggle("edit-on", edit);

  handleColorPicker.style.display = edit ? "inline-block" : "none";
  bgScaleInput.style.display = edit ? "inline-block" : "none";

  render();
};


handleColorPicker.oninput = (e) => {
  handleColor = e.target.value;
  localStorage.setItem("handleColor", handleColor);
  render();
};




/* ê²€ìƒ‰ */
search.oninput=e=>{searchText=e.target.value.toLowerCase();render();}
search.addEventListener("input", () => {
  clearSearch.style.display = search.value ? "block" : "none";
});

/* ë°°ê²½ */
bgBtn.onclick=()=>{if(edit) bgInput.click();}
bgInput.onchange=e=>{
 const f=e.target.files[0]; if(!f)return;
 const r=new FileReader();
 r.onload=()=>{canvas.style.backgroundImage=`url(${r.result})`; localStorage.setItem("bg",r.result);}
 r.readAsDataURL(f);
};
const bg=localStorage.getItem("bg"); if(bg) canvas.style.backgroundImage=`url(${bg})`;
canvas.style.transform = `scale(${bgScale})`;


/* ì €ì¥/ì‚­ì œ */
function save(){localStorage.setItem("myData",JSON.stringify(myData));}
function remove(id){myData=myData.filter(x=>x.id!==id); items=myData; save(); render();}

/* í¬ì»¤ìŠ¤ í•´ì œ */
function clearFocus(){selected=null; render();}

/* ë°°ê²½ í´ë¦­ */
imageArea.addEventListener("pointerdown", e=>{
 if(e.target===imageArea||e.target===canvas){
  clearFocus();
  if(edit && mode==="my"){
   const r=imageArea.getBoundingClientRect();
   const px = (e.clientX - r.left) / r.width * 100;
const py = (e.clientY - r.top) / r.height * 100;

myData.push({
  id: Date.now(),
  name: "í•­ëª©",
  desc: "ì„¤ëª…",
  x: px,
  y: py,
  lx: showLinks ? px + 8 : null,
  ly: showLinks ? py + 8 : null
});

   save(); render();
  }
 }
});

/* ë“œë˜ê·¸ */
let dragItem=null, dragType=null;
document.addEventListener("pointermove", e=>{
 if(!dragItem) return;
 if(!edit || mode!=="my") return;
 const r=imageArea.getBoundingClientRect();
 const x=(e.clientX-r.left)/r.width*100;
 const y=(e.clientY-r.top)/r.height*100;
 if(dragType==="item"){if(dragItem.lx!==null){dragItem.lx=x; dragItem.ly=y;} else{dragItem.x=x; dragItem.y=y;}}
 if(dragType==="start"){dragItem.x=x; dragItem.y=y;}
 if(dragType==="end"){dragItem.lx=x; dragItem.ly=y;}
 save(); render();
});
document.addEventListener("pointerup",()=>dragItem=null);

/* =======================
   ë Œë” (ì—¬ê¸°ë§Œ ìˆ˜ì •ë¨)
   ======================= */
function render(){
 hits.innerHTML="";
 list.innerHTML="";
 lines.innerHTML="";
 lines.setAttribute("width",imageArea.clientWidth);
 lines.setAttribute("height",imageArea.clientHeight);

 /* ğŸ” [ì¶”ê°€] ê²€ìƒ‰ ë§¤ì¹­ ID */
 const matchedIds = new Set(
   items
     .filter(it =>
       it.name.toLowerCase().includes(searchText) ||
       it.desc.toLowerCase().includes(searchText)
     )
     .map(it => it.id)
 );

 /* ğŸ“‹ ë¦¬ìŠ¤íŠ¸ìš© í•„í„° */
 const filtered = searchText
   ? items.filter(it => matchedIds.has(it.id))
   : items;

 /* ===== ê·¸ë¦¼ì€ ì „ì²´ items ê¸°ì¤€ ===== */
 items.forEach(it=>{
  const hx=it.lx??it.x;
  const hy=it.ly??it.y;
  const isMatch = matchedIds.has(it.id);

  /* ì„  */
/* ì„  */
if (showLinks && it.lx !== null) {
  const sx = it.x / 100 * imageArea.clientWidth;
  const sy = it.y / 100 * imageArea.clientHeight;
  const ex = it.lx / 100 * imageArea.clientWidth;
  const ey = it.ly / 100 * imageArea.clientHeight;

  const dx = ex - sx;
  const dy = ey - sy;
  const len = Math.hypot(dx, dy) || 1;

  const labelOffset = 15;   
  const handleOffset = 30;  

  const x1 = sx + (dx / len) * labelOffset;
  const y1 = sy + (dy / len) * labelOffset;
  const x2 = ex - (dx / len) * handleOffset;
  const y2 = ey - (dy / len) * handleOffset;

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("stroke", "#444");
  line.setAttribute("stroke-width", "2");
  // ğŸ”¹ ê²€ìƒ‰ ë¯¸ë§¤ì¹­ì´ë©´ íˆ¬ëª…ë„ ë‚®ì¶”ê¸°
  line.setAttribute("opacity", isMatch ? "1" : "0.25");

  lines.appendChild(line);

  ["start"].forEach(type=>{
    const h = document.createElement("div");
    h.className="handle";
    h.style.left = (type==="start"?it.x:it.lx) + "%";
    h.style.top  = (type==="start"?it.y:it.ly) + "%";
    h.style.background = handleColor;
    // ğŸ”¹ ê²€ìƒ‰ ë¯¸ë§¤ì¹­ì´ë©´ íˆ¬ëª…ë„ ë‚®ì¶”ê¸°
    h.style.opacity = isMatch ? "1" : "0.25";

    h.onpointerdown = e=>{
      if(edit && mode==="my"){
        dragItem=it;
        dragType=type;
        e.stopPropagation();
      }
    };
    hits.appendChild(h);
  });
}

  /* í•­ëª© */
  const d=document.createElement("div");
  d.className=
    "hit"+
    (it.id===selected?" active":"")+
    (searchText && isMatch?" search-hit":"");

  if (searchText && !isMatch) {
    d.style.opacity="0.25";
  }

  d.style.left=hx+"%";
  d.style.top=hy+"%";
  d.textContent=it.name;

  let lastTap=0;
  d.onpointerdown=e=>{
   e.stopPropagation();
   const now=Date.now();
   selected=it.id;

   if(edit && mode==="my" && now-lastTap<300){
    if(it.lx===null){
     it.lx=it.x+10; it.ly=it.y+10;
    }else{
     it.lx=null; it.ly=null;
    }
    save(); render(); return;
   }
   lastTap=now;

   if(edit && mode==="my"){
    dragItem=it; dragType="item";
   }
   render();
  };

  d.oncontextmenu=e=>{
   e.preventDefault();
   if(!edit||mode!=="my")return;
   const v=prompt("ì´ë¦„ ìˆ˜ì •",it.name);
   if(v!==null){it.name=v; save(); render();}
  };

  hits.appendChild(d);
 });

 /* ===== ë¦¬ìŠ¤íŠ¸ëŠ” filtered ê¸°ì¤€ ===== */
 filtered.forEach(it=>{
  const li=document.createElement("li");
  li.style.paddingRight = "32px";
  if(it.id===selected) li.className="active";

  const del=document.createElement("span");
  del.className="del";
  del.textContent="âœ•";
  del.onclick=e=>{
    e.stopPropagation();
    if(edit && mode==="my") remove(it.id);
  };
  if (!edit) del.style.display = "none";
  const title=document.createElement("div");
  title.textContent=it.name;
  if(edit && mode==="my"){
  title.onclick=e=>{
    e.stopPropagation();
    title.contentEditable=true;
    title.focus();
  };
}
  title.oninput=()=>{it.name=title.textContent; save();};
  title.onblur=()=>title.contentEditable=false;

  const detail=document.createElement("div");
  detail.className="detail";
  detail.textContent=it.desc;
  if(edit){
   detail.onclick=e=>{
    e.stopPropagation();
    detail.contentEditable=true;
    detail.focus();
   };
  }
  detail.oninput=()=>{it.desc=detail.textContent; save();};
  detail.onblur=()=>detail.contentEditable=false;

  if(it.id===selected || searchText){
    detail.style.display="block";
  }

  li.onclick = (e) => {
  if (edit && e.target !== li) return; // íƒ€ì´í‹€/ë””í…Œì¼ í´ë¦­ì€ ë¬´ì‹œ
  selected = it.id;
  render();
};

  li.appendChild(del);
  li.appendChild(title);
  li.appendChild(detail);
  list.appendChild(li);
 });
}

/* PNG */
pngBtn.onclick = async () => {
  const name = prompt("ì´ë¯¸ì§€ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "map");
  if (!name) return;

  const scale = 3; // â­ í™”ì§ˆ (2~4 ê°€ëŠ¥)

  const rect = imageArea.getBoundingClientRect();

  const exportCanvas = document.createElement("canvas");
  exportCanvas.width = rect.width * scale;
  exportCanvas.height = rect.height * scale;

  const ctx = exportCanvas.getContext("2d");
  ctx.scale(scale, scale);

  // ë°°ê²½ìƒ‰
  ctx.fillStyle = "#f7fafc";
  ctx.fillRect(0, 0, rect.width, rect.height);

  // ë°°ê²½ ì´ë¯¸ì§€
  const bg = canvas.style.backgroundImage;
  if (bg && bg.startsWith("url")) {
    const url = bg.slice(5, -2);
    const img = new Image();
    img.src = url;
    await img.decode();

    const imgRatio = img.width / img.height;
const areaRatio = rect.width / rect.height;

let drawW, drawH, offsetX, offsetY;

if (imgRatio > areaRatio) {
  drawW = rect.width;
  drawH = rect.width / imgRatio;
} else {
  drawH = rect.height;
  drawW = rect.height * imgRatio;
}

/* ğŸ”¥ bgScale ë°˜ì˜ */
drawW *= bgScale;
drawH *= bgScale;

/* ğŸ”¥ ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¼ */
offsetX = (rect.width - drawW) / 2;
offsetY = (rect.height - drawH) / 2;

ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
/* ğŸ”µ í•¸ë“¤ í¬ì¸íŠ¸ (í…ìŠ¤íŠ¸ ìª½ì— ë‹¬ê¸°) */
items.forEach(it => {
  if (!showLinks || it.lx === null) return;

  const x = it.x / 100 * rect.width;
  const y = it.y / 100 * rect.height;

  ctx.beginPath();
  const r = 6 / scale; // â­ í™”ë©´ê³¼ ë™ì¼í•œ í¬ê¸°
ctx.arc(x, y, r, 0, Math.PI * 2);

  ctx.fillStyle = handleColor;
  ctx.fill();
});

  }

  // SVG ì„  ê·¸ë¦¬ê¸°
  // SVG ì„  ê·¸ë¦¬ê¸° (í™”ë©´ ê±°ë¦¬ ìœ ì§€)
items.forEach(it => {
  if (!showLinks || it.lx === null) return;

  const sx = it.x / 100 * rect.width;
  const sy = it.y / 100 * rect.height;
  const ex = it.lx / 100 * rect.width;
  const ey = it.ly / 100 * rect.height;

  const dx = ex - sx;
  const dy = ey - sy;
  const len = Math.hypot(dx, dy) || 1;

  // â­ í™”ë©´ì—ì„œ ì“°ë˜ ê±°ë¦¬ê°’ì´ë‘ ë§ì¶”ê¸°
  const labelOffset = 15;   // í…ìŠ¤íŠ¸ì—ì„œ ë–¨ì–´ì§„ ê±°ë¦¬
  const handleOffset = 30;  // í•¸ë“¤ì—ì„œ ë–¨ì–´ì§„ ê±°ë¦¬

  const x1 = sx + (dx / len) * labelOffset;
  const y1 = sy + (dy / len) * labelOffset;
  const x2 = ex - (dx / len) * handleOffset;
  const y2 = ey - (dy / len) * handleOffset;

  ctx.strokeStyle = "#444";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.stroke();
});


  // ë¼ë²¨
  ctx.fillStyle = "#000";
  ctx.font = "14px 'Playwrite NZ Basic', cursive";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  items.forEach(it => {
    const x = (it.lx ?? it.x) / 100 * rect.width;
    const y = (it.ly ?? it.y) / 100 * rect.height;

    ctx.fillText(it.name, x, y);
  });

  exportCanvas.toBlob(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name + ".png";
    a.click();
    URL.revokeObjectURL(a.href);
  });
};



/* JSON */
jsonOut.onclick = () => {
  const name = prompt("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "map");
  if (!name) return;

  const jsonBlob = new Blob(
    [JSON.stringify(myData, null, 2)],
    { type: "application/json" }
  );

  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonA = document.createElement("a");
  jsonA.href = jsonUrl;
  jsonA.download = name + ".json";
  document.body.appendChild(jsonA);
  jsonA.click();
  document.body.removeChild(jsonA);
  URL.revokeObjectURL(jsonUrl);
};


jsonIn.onclick=()=>jsonFile.click();
jsonFile.onchange=e=>{
 const f=e.target.files[0]; if(!f)return;
 const r=new FileReader();
 r.onload=()=>{
  tplData=JSON.parse(r.result);
  mode="tpl"; items=tplData;
  tabTpl.classList.add("active");
  tabMy.classList.remove("active");
  render();
 };
 r.readAsText(f);
};

render();
clearSearch.onclick = () => {
  search.value = "";
  searchText = "";
  clearSearch.style.display = "none";
  render();
};

bgScaleInput.value = bgScale;

bgScaleInput.oninput = (e) => {
  bgScale = e.target.value;
  canvas.style.transform = `scale(${bgScale})`;
  localStorage.setItem("bgScale", bgScale);
};

</script>

</body>
</html>