<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;display:flex;height:100vh;font-family:sans-serif;background:#fdfefe;}
#left{flex:8;display:flex;flex-direction:column}

.tabs{display:flex;height:36px;background:#eef5fb;border-bottom:1px solid #d6e2ee;}
.tab{flex:1;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.tab.active{background:white;font-weight:bold}

#imageArea{flex:1;position:relative;background:#f7fafc;overflow:hidden;touch-action:none;}
#canvas{width:100%;height:100%;background-size:contain;background-position:center;background-repeat:no-repeat;}
#lines{position:absolute;inset:0;pointer-events:none;}

.hit{
 position:absolute;
 transform:translate(-50%,-50%);
 background:#fff;
 border:1px solid #c9d6e2;
 padding:5px 9px;
 border-radius:10px;
 cursor:pointer;
}
.hit.active{background:#e8f4ff;}

.handle{
 position:absolute;
 width:14px;height:14px;
 border-radius:50%;
 background:white;
 border:2px solid #4a90e2;
 transform:translate(-50%,-50%);
 cursor:pointer;
}

#side{flex:2;border-left:1px solid #d6e2ee;display:flex;flex-direction:column;}
#search{padding:8px;border:none;border-bottom:1px solid #dde7f0;}

ul{list-style:none;margin:0;padding:0;flex:1;overflow:auto}
li{padding:8px;border-bottom:1px solid #eef2f6;cursor:pointer}
li.active{background:#eaf4ff}

.detail{display:none;font-size:13px;color:#666;margin-top:4px}

#bar{position:fixed;bottom:10px;left:10px;background:white;padding:8px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.12);}
button{margin:2px;padding:6px 12px;border-radius:8px;border:none;cursor:pointer;}
.edit-on{background:#a8d8ff;}
</style>
</head>

<body>

<div id="left">
<div class="tabs">
<div id="tabMy" class="tab active">내 작업</div>
<div id="tabTpl" class="tab">템플릿</div>
</div>

<div id="imageArea">
<div id="canvas"></div>
<svg id="lines"></svg>
<div id="hits"></div>
</div>
</div>

<div id="side">
<input id="search" placeholder="검색...">
<ul id="list"></ul>
</div>

<div id="bar">
<button id="editBtn">편집</button>
<button id="bgBtn">배경</button>
<button id="pngBtn">PNG</button>
<button id="jsonOut">JSON↓</button>
<button id="jsonIn">JSON↑</button>

<input type="file" id="bgInput" hidden accept="image/*">
<input type="file" id="jsonFile" hidden accept=".json">
</div>

<script>
/* 검색 */
const search=document.getElementById("search");
search.oninput=e=>{
 searchText=e.target.value.toLowerCase();
 render();
};

/* 드래그 */
document.addEventListener("pointermove",e=>{
 if(!dragItem) return;
 if(!edit || mode!=="my") return; // 편집모드가 아니면 이동 금지

 const r=imageArea.getBoundingClientRect();
 const x=(e.clientX-r.left)/r.width*100;
 const y=(e.clientY-r.top)/r.height*100;

 if(dragType==="item"){ 
  if(dragItem.lx!==null){dragItem.lx=x; dragItem.ly=y;} 
  else{dragItem.x=x; dragItem.y=y;}
 }
 if(dragType==="start"){dragItem.x=x; dragItem.y=y;}
 if(dragType==="end"){dragItem.lx=x; dragItem.ly=y;}

 save(); render();
});
document.addEventListener("pointerup",()=>dragItem=null);

/* 렌더 */
function render(){
 hits.innerHTML=""; list.innerHTML=""; lines.innerHTML="";
 lines.setAttribute("width",imageArea.clientWidth);
 lines.setAttribute("height",imageArea.clientHeight);

 const filtered = items.filter(it=>
  it.name.toLowerCase().includes(searchText) ||
  it.desc.toLowerCase().includes(searchText)
 );

 filtered.forEach(it=>{
  const hx=it.lx??it.x;
  const hy=it.ly??it.y;

  /* 선 */
  if(it.lx!==null){
   const line=document.createElementNS("http://www.w3.org/2000/svg","line");
   line.setAttribute("x1",it.x/100*imageArea.clientWidth);
   line.setAttribute("y1",it.y/100*imageArea.clientHeight);
   line.setAttribute("x2",it.lx/100*imageArea.clientWidth);
   line.setAttribute("y2",it.ly/100*imageArea.clientHeight);
   line.setAttribute("stroke","#444");
   line.setAttribute("stroke-width","2");
   lines.appendChild(line);

   if(edit && mode==="my"){ // 편집모드일 때만 핸들 보이고 이동 가능
    ["start","end"].forEach(type=>{
     const h=document.createElement("div");
     h.className="handle";
     h.style.left=(type==="start"?it.x:it.lx)+"%";
     h.style.top=(type==="start"?it.y:it.ly)+"%";
     h.onpointerdown=e=>{dragItem=it; dragType=type; e.stopPropagation();}
     hits.appendChild(h);
    });
   }
  }

  /* 항목 */
  const d=document.createElement("div");
  d.className="hit"+(it.id===selected?" active":"");
  d.style.left=hx+"%";
  d.style.top=hy+"%";
  d.textContent=it.name;

  if(edit && mode==="my"){ // 편집모드일 때만 항목 이동 가능
   let pressTimer=null;
   d.onpointerdown=e=>{
    e.stopPropagation();
    selected=it.id;
    dragItem=it;
    dragType="item";
   };
   d.onpointerup=()=>clearTimeout(pressTimer);
  }
  hits.appendChild(d);

  /* 리스트 */
  const li=document.createElement("li");
  if(it.id===selected) li.className="active";

  const del=document.createElement("span");
  del.textContent="✕";
  del.className="del";
  del.onclick=e=>{
   e.stopPropagation();
   if(edit && mode==="my"){
    myData=myData.filter(x=>x.id!==it.id);
    items=myData;
    save();
    render();
   }
  };
  li.appendChild(del);

  const title=document.createElement("div");
  title.textContent=it.name;
  if(edit) title.contentEditable=true;
  title.oninput=()=>{it.name=title.textContent; save();};

  const detail=document.createElement("div");
  detail.className="detail";
  detail.textContent=it.desc;
  if(edit) detail.contentEditable=true;
  detail.oninput=()=>{it.desc=detail.textContent; save();};

  if(it.id===selected) detail.style.display="block";

  li.onclick=()=>{selected=it.id; render();};

  li.appendChild(title);
  li.appendChild(detail);
  list.appendChild(li);
 });
}
</script>
</body>
</html>