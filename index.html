<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³µê°„ ë„¤ì´ë° ë§µ</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box;font-family:'Nanum Pen Script',sans-serif;}
body{margin:0;background:#faf7f2;}

/* ë ˆì´ì•„ì›ƒ */
.container{
  display:grid;
  grid-template-columns:8fr 2fr;
  height:100vh;
}

.mode-badge{
  position:fixed;top:10px;left:10px;
  padding:6px 12px;
  background:#ffe066;
  border:2px solid #333;
  display:none;z-index:999;
}

.image-area{
  position:relative;
  border:2px solid #444;
  background:white;
  overflow:hidden;
}

#canvas{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  background-position:center;
  background-repeat:no-repeat;
  background-size:contain;
}

.sketch-bg{
  position:absolute;inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,0.05) 1px,
    transparent 2px,
    transparent 6px
  );
}

.hit-area{
  position:absolute;
  transform:translate(-50%,-50%);
}

.hit-title{
  background:#fffdf5;
  border:1px solid #333;
  padding:4px 8px;
  cursor:pointer;
}

.highlight{
  position:absolute;
  width:40px;height:26px;
  background:rgba(255,235,59,0.7);
  border-radius:50%;
  transform:translate(-50%,-50%);
  display:none;
  pointer-events:none;
}

.info-area{
  border-left:2px dashed #aaa;
  padding:10px;
  overflow-y:auto;
}

.top-bar{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
button{font-size:18px;cursor:pointer;}
.edit-on{background:#ff7675;color:white;}
.search{flex:1;padding:6px;}
li{
  background:#fffdf5;
  margin-bottom:8px;
  padding:8px;
  border:1px solid #ccc;
  cursor:pointer;
}
.detail{
  display:none;
  margin-top:6px;
  border-left:4px solid #f4d03f;
  padding-left:6px;
}
.del-btn{
  float:right;
  cursor:pointer;
}
@media(max-width:1024px){
  .container{grid-template-columns:1fr;}
  .info-area{position:fixed;bottom:0;left:0;right:0;height:200px;background:#fffdf5;overflow-y:auto;}
  .top-bar{position:fixed;bottom:0;left:0;right:0;padding:6px;background:#fffdf5;z-index:999;}
  #itemList{padding-bottom:50px;}
}
</style>
</head>

<body>
<div id="modeBadge" class="mode-badge">âœï¸ í¸ì§‘ëª¨ë“œ</div>

<div class="container" id="captureRoot">
  <div class="image-area" id="imageArea">
    <div id="canvas">
      <div class="sketch-bg"></div>
      <div id="hitAreas"></div>
      <div id="highlight" class="highlight"></div>
    </div>
  </div>

  <div class="info-area" id="listPanel">
    <div class="top-bar">
      <button id="editBtn">âœï¸</button>
      <button id="imgBtn">ğŸ“·</button>
      <button id="clearImgBtn">âŒ</button>
      <button id="exportBtn">ğŸ’¾</button>
      <label>
        <input type="checkbox" id="includeList" checked> ë¦¬ìŠ¤íŠ¸ í¬í•¨
      </label>
      <input type="file" id="imgInput" accept="image/*" hidden>
      <input id="searchBox" class="search" placeholder="ê²€ìƒ‰">
    </div>
    <ul id="itemList"></ul>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://kpebsyuqtrvwbgbrvxoy.supabase.co'
const SUPABASE_ANON_KEY = 'sb_publishable_aOx9dt3MyHESbd1T_CyQ3Q_ANSIepqb'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let items=[]
let editMode=false

const canvas=document.getElementById("canvas")
const imageArea=document.getElementById("imageArea")
const hitWrap=document.getElementById("hitAreas")
const listEl=document.getElementById("itemList")
const highlight=document.getElementById("highlight")
const badge=document.getElementById("modeBadge")
const editBtn=document.getElementById("editBtn")
const searchBox=document.getElementById("searchBox")
const imgInput=document.getElementById("imgInput")
const clearImgBtn=document.getElementById("clearImgBtn")
const imgBtn=document.getElementById("imgBtn")
const exportBtn=document.getElementById("exportBtn")

/* í¸ì§‘ëª¨ë“œ */
editBtn.onclick=()=>{
  editMode=!editMode
  editBtn.classList.toggle("edit-on",editMode)
  badge.style.display=editMode?"block":"none"
}

/* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
imgBtn.onclick=()=>{ if(!editMode)return; imgInput.click() }

imgInput.onchange=async e=>{
  if(!editMode) return
  const f=e.target.files[0]
  if(!f)return
  const fileName=`bg_${Date.now()}_${f.name}`
  const { data, error } = await supabase.storage.from('backgrounds').upload(fileName,f)
  if(error){alert(error.message);return}
  const { data: urlData } = supabase.storage.from('backgrounds').getPublicUrl(fileName)
  canvas.style.background=`url(${urlData.publicUrl}) center/contain no-repeat`
}

/* ì´ë¯¸ì§€ ì´ˆê¸°í™” */
clearImgBtn.onclick=()=>{ if(!editMode) return; canvas.style.background="" }

/* ì €ì¥ */
const save=it=>supabase.from('items').upsert(it)

/* ì‚­ì œ */
async function remove(id){
  await supabase.from('items').delete().eq('id',id)
  items=items.filter(i=>i.id!==id)
  render()
}

/* í¸ì§‘ */
function makeEditable(el,onSave){
  el.contentEditable=true
  el.focus()
  el.onblur=()=>{el.contentEditable=false;onSave(el.innerText)}
}

/* ë Œë” */
function render(){renderHits();renderList()}

/* ë¼ë²¨ */
function renderHits(){
  hitWrap.innerHTML=""
  items.forEach(it=>{
    const d=document.createElement("div")
    d.className="hit-area"
    d.style.left=it.x+"%"
    d.style.top=it.y+"%"

    const t=document.createElement("div")
    t.className="hit-title"
    t.innerText=it.name
    t.ondblclick=e=>{if(!editMode)return; e.stopPropagation(); makeEditable(t,v=>{it.name=v;save(it);render()})}
    d.onclick=e=>{e.stopPropagation(); select(it,true)}
    d.appendChild(t)
    hitWrap.appendChild(d)
  })
}

/* ë¦¬ìŠ¤íŠ¸ */
function renderList(){
  listEl.innerHTML=""
  const q=searchBox.value.toLowerCase()
  const filtered=items.filter(i=>(i.name||"").toLowerCase().includes(q) || (i.desc||"").toLowerCase().includes(q))
  filtered.forEach(it=>{
    const li=document.createElement("li")
    const del=document.createElement("span")
    del.innerText="âœ–"
    del.className="del-btn"
    del.onclick=e=>{e.stopPropagation();if(editMode)remove(it.id)}

    const title=document.createElement("div")
    title.innerText=it.name
    title.ondblclick=e=>{if(!editMode)return; makeEditable(title,v=>{it.name=v;save(it);render()})}

    const detail=document.createElement("div")
    detail.className="detail"
    detail.innerText=it.desc||"ì„¤ëª…"
    detail.ondblclick=e=>{if(!editMode)return; makeEditable(detail,v=>{it.desc=v;save(it)})}

    li.onclick=()=>{
      document.querySelectorAll(".detail").forEach(d=>d.style.display="none")
      detail.style.display="block"
      select(it,false)
    }

    li.append(del,title,detail)
    listEl.appendChild(li)
  })
}

/* ì„ íƒ */
function select(it,openList){
  highlight.style.left=it.x+"%"
  highlight.style.top=it.y+"%"
  highlight.style.display="block"
  if(openList){
    const idx=items.indexOf(it)
    const li=listEl.children[idx]
    if(li){const d=li.querySelector(".detail"); document.querySelectorAll(".detail").forEach(x=>x.style.display="none"); d.style.display="block"}
  }
}

/* ë¹ˆê³µê°„ í´ë¦­ í•´ì œ */
imageArea.addEventListener("click",e=>{
  if(editMode)return
  if(!e.target.closest(".hit-area")){
    highlight.style.display="none"
    document.querySelectorAll(".detail").forEach(d=>d.style.display="none")
  }
})

/* ì¶”ê°€ */
imageArea.ondblclick=e=>{
  if(!editMode)return
  const r=imageArea.getBoundingClientRect()
  const it={
    id:Date.now(),
    name:"ìƒˆ ë¬¼ê±´",
    x:(e.clientX-r.left)/r.width*100,
    y:(e.clientY-r.top)/r.height*100,
    desc:"ì„¤ëª…"
  }
  items.push(it)
  save(it)
  render()
}

/* ê²€ìƒ‰ */
searchBox.oninput=renderList

/* ë‚´ë³´ë‚´ê¸° */
exportBtn.onclick=async ()=>{
  if(editMode){alert("ë·°ì–´ëª¨ë“œì—ì„œë§Œ ë‚´ë³´ë‚´ê¸° ê°€ëŠ¥"); return}
  const include=document.getElementById("includeList").checked
  const target=include ? document.getElementById("captureRoot") : document.getElementById("imageArea")
  const canvasCap=await html2canvas(target)
  const link=document.createElement("a")
  link.download="map.png"
  link.href=canvasCap.toDataURL("image/png")
  link.click()
}

/* ë¡œë“œ */
async function loadItems(){
  const { data, error } = await supabase.from('items').select('*')
  items=data||[{id:1,name:"ì˜ˆì‹œ",x:50,y:50,desc:"ì„¤ëª…"}]
  render()
}
loadItems()
</script>
</body>
</html>