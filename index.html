<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{margin:0;display:flex;height:100vh;font-family:sans-serif}

/* ===== ê·¸ë¦¼ì˜ì—­ ===== */
#left{
 flex:8;
 display:flex;
 flex-direction:column;
}

.tab{
 background:#f4d03f;
 padding:8px 14px;
 border-bottom:2px solid #999;
 font-weight:bold;
}

#imageArea{
 flex:1;
 position:relative;
 background:#eee;
 border:4px solid #999;
}
#imageArea.template{border-color:#4a90e2}

#canvas{
 width:100%;height:100%;
 background-size:contain;
 background-position:center;
 background-repeat:no-repeat;
}

.hit-area{
 position:absolute;
 transform:translate(-50%,-50%);
 cursor:pointer;
}

.hit-title{
 background:#fffdf5;
 border:1px solid rgba(0,0,0,.4);
 padding:6px 10px;
 border-radius:10px;
}

/* í˜•ê´‘íœ í¬ì»¤ìŠ¤ */
.focused{
 background:linear-gradient(
  to top,
  rgba(255,255,0,.6) 40%,
  transparent 40%
 );
}

/* ===== ë¦¬ìŠ¤íŠ¸ ===== */
#side{
 flex:2;
 border-left:1px solid #ccc;
 display:flex;
 flex-direction:column;
}

#status{
 padding:6px;
 font-size:12px;
 background:#f3f3f3;
}

ul{list-style:none;margin:0;padding:0;overflow:auto;flex:1}
li{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
li.active{background:#f0f0f0}

.detail{display:none;font-size:13px;color:#555}

/* ===== ë²„íŠ¼ë°” ===== */
#topbar{
 position:fixed;
 bottom:10px;
 left:10px;
 background:#fff;
 padding:6px;
 border-radius:10px;
 box-shadow:0 2px 6px rgba(0,0,0,.2);
}
button{margin:2px}
.edit-on{background:#4caf50;color:white}
</style>
</head>

<body>

<div id="left">
 <div class="tab" id="tabTitle">ğŸ“ ë‚´ ì‘ì—…</div>
 <div id="imageArea">
  <div id="canvas"></div>
  <div id="hitWrap"></div>
 </div>
</div>

<div id="side">
 <div id="status">ë‚´ ì‘ì—… ìƒíƒœ</div>
 <ul id="list"></ul>
</div>

<div id="topbar">
 <button id="editBtn">í¸ì§‘</button>
 <button id="imgBtn">ë°°ê²½</button>

 <button id="pngBtn">PNG</button>
 <button id="jsonBtn">JSON</button>

 <button id="saveTplBtn">í…œí”Œë¦¿ì €ì¥</button>
 <button id="loadTplBtn">í…œí”Œë¦¿ë¶ˆëŸ¬ì˜¤ê¸°</button>
 <button id="copyBtn">ë‚´ì‘ì—…ë³µì‚¬</button>

 <input type="file" id="imgInput" hidden accept="image/*">
 <input type="file" id="jsonInput" hidden accept=".json">
</div>

<script>
/* ===== ìš”ì†Œ ===== */
const imageArea=document.getElementById("imageArea");
const canvas=document.getElementById("canvas");
const hitWrap=document.getElementById("hitWrap");
const list=document.getElementById("list");
const statusBar=document.getElementById("status");
const tabTitle=document.getElementById("tabTitle");

const editBtn=document.getElementById("editBtn");
const imgBtn=document.getElementById("imgBtn");
const pngBtn=document.getElementById("pngBtn");
const jsonBtn=document.getElementById("jsonBtn");
const saveTplBtn=document.getElementById("saveTplBtn");
const loadTplBtn=document.getElementById("loadTplBtn");
const copyBtn=document.getElementById("copyBtn");

const imgInput=document.getElementById("imgInput");
const jsonInput=document.getElementById("jsonInput");

/* ===== ë°ì´í„° ===== */
let myItems=JSON.parse(localStorage.getItem("mapData")||"[]");
let templates=JSON.parse(localStorage.getItem("templates")||"[]");

let items=myItems;
let editMode=false;
let selected=null;
let viewingTemplate=false;

/* ===== ì €ì¥ ===== */
function save(){
 localStorage.setItem("mapData",JSON.stringify(myItems));
 localStorage.setItem("templates",JSON.stringify(templates));
}

/* ===== í¸ì§‘ëª¨ë“œ ===== */
editBtn.onclick=()=>{
 editMode=!editMode;
 editBtn.classList.toggle("edit-on",editMode);
};

/* ===== ë°°ê²½ ===== */
imgBtn.onclick=()=>{ if(editMode) imgInput.click(); };

imgInput.onchange=e=>{
 const f=e.target.files[0];
 if(!f)return;
 const r=new FileReader();
 r.onload=()=>{
  canvas.style.backgroundImage=`url(${r.result})`;
  localStorage.setItem("bg",r.result);
 };
 r.readAsDataURL(f);
};

const bg=localStorage.getItem("bg");
if(bg) canvas.style.backgroundImage=`url(${bg})`;

/* ===== ì•„ì´í…œ ì¶”ê°€ ===== */
imageArea.ondblclick=e=>{
 if(!editMode||viewingTemplate)return;

 const r=imageArea.getBoundingClientRect();
 items.push({
  id:Date.now(),
  name:"í•­ëª©",
  desc:"ì„¤ëª…",
  x:(e.clientX-r.left)/r.width*100,
  y:(e.clientY-r.top)/r.height*100
 });

 myItems=items;
 save();
 render();
};

/* ===== ì„ íƒ ===== */
function select(it){
 selected=it.id;
 render();
}

/* ===== ë Œë” ===== */
function render(){
 hitWrap.innerHTML="";
 list.innerHTML="";

 items.forEach(it=>{
  const d=document.createElement("div");
  d.className="hit-area";
  d.style.left=it.x+"%";
  d.style.top=it.y+"%";

  const t=document.createElement("div");
  t.className="hit-title"+(it.id===selected?" focused":"");
  t.textContent=it.name;

  t.onclick=e=>{
   e.stopPropagation();
   if(editMode){
    t.contentEditable=true;
    t.focus();
    t.onblur=()=>{
     t.contentEditable=false;
     it.name=t.textContent;
     if(!viewingTemplate){myItems=items;save();}
    };
   }else select(it);
  };

  d.appendChild(t);
  hitWrap.appendChild(d);

  const li=document.createElement("li");
  if(it.id===selected) li.className="active";

  const title=document.createElement("div");
  title.textContent=it.name;

  const det=document.createElement("div");
  det.className="detail";
  det.textContent=it.desc||"";
  if(it.id===selected) det.style.display="block";

  det.onclick=e=>{
   e.stopPropagation();
   if(!editMode)return;
   det.contentEditable=true;
   det.focus();
   det.onblur=()=>{
    det.contentEditable=false;
    it.desc=det.textContent;
    if(!viewingTemplate){myItems=items;save();}
   };
  };

  li.onclick=()=>select(it);

  li.appendChild(title);
  li.appendChild(det);
  list.appendChild(li);
 });
}

/* ===== PNG ===== */
pngBtn.onclick=()=>{
 html2canvas(imageArea).then(c=>{
  const a=document.createElement("a");
  a.href=c.toDataURL();
  a.download="map.png";
  a.click();
 });
};

/* ===== JSON ë‚´ë³´ë‚´ê¸° (ë³µêµ¬!) ===== */
jsonBtn.onclick=()=>{
 const data={
  name:"export",
  data:items
 };
 const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="template.json";
 a.click();
};

/* ===== í…œí”Œë¦¿ ì €ì¥ ===== */
saveTplBtn.onclick=()=>{
 const name=prompt("í…œí”Œë¦¿ ì´ë¦„?");
 if(!name)return;
 templates.push({name,data:myItems});
 save();
 alert("ì €ì¥ë¨");
};

/* ===== í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ===== */
loadTplBtn.onclick=()=>jsonInput.click();

jsonInput.onchange=e=>{
 const f=e.target.files[0];
 if(!f)return;
 const r=new FileReader();
 r.onload=()=>{
  const t=JSON.parse(r.result);
  items=t.data;
  viewingTemplate=true;

  tabTitle.innerText="ğŸ“‚ í…œí”Œë¦¿ ë³´ê¸°";
  statusBar.innerText="í…œí”Œë¦¿ ìƒíƒœ";
  imageArea.classList.add("template");

  render();
 };
 r.readAsText(f);
};

/* ===== í…œí”Œë¦¿ â†’ ë‚´ì‘ì—… ===== */
copyBtn.onclick=()=>{
 if(!viewingTemplate)return alert("í…œí”Œë¦¿ ìƒíƒœì—ì„œë§Œ ê°€ëŠ¥");

 myItems=JSON.parse(JSON.stringify(items));
 items=myItems;
 viewingTemplate=false;

 tabTitle.innerText="ğŸ“ ë‚´ ì‘ì—…";
 statusBar.innerText="ë‚´ ì‘ì—… ìƒíƒœ";
 imageArea.classList.remove("template");

 save();
 render();
};

render();
</script>
</body>
</html>