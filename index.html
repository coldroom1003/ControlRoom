<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

<style>
body{margin:0;font-family:sans-serif;display:flex;height:100vh;overflow:hidden}

#imageArea{flex:8;position:relative;background:#eee}
#canvas{
 width:100%;height:100%;
 background-size:contain;
 background-position:center;
 background-repeat:no-repeat;
}

#hitWrap{position:absolute;inset:0}

/* ğŸ¨ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ê°œì„  */
.hit-title{
 background:#fffdf5;
 border:1px solid rgba(0,0,0,.3);
 border-radius:14px 10px 16px 12px;
 padding:5px 10px;
 box-shadow:1px 1px 2px rgba(0,0,0,.15);
 position:relative;
}

/* âœ¨ í˜•ê´‘íœ íš¨ê³¼ */
.hit-title.focused::after{
 content:"";
 position:absolute;
 left:-5%;
 bottom:2px;
 width:0%;
 height:8px;
 background:rgba(255,255,0,.6);
 z-index:-1;
 animation:highlight 1s forwards;
}

@keyframes highlight{
 from{width:0%}
 to{width:110%}
}

.hit-area{
 position:absolute;
 transform:translate(-50%,-50%);
 cursor:pointer;
}

#side{
 flex:2;
 border-left:1px solid #ccc;
 display:flex;
 flex-direction:column;
}

#tabs{
 display:flex;
 border-bottom:1px solid #ccc;
}
.tab{
 flex:1;
 padding:8px;
 text-align:center;
 cursor:pointer;
 background:#f5f5f5;
}
.tab.active{background:#fff;font-weight:bold}

ul{list-style:none;margin:0;padding:0;overflow:auto;flex:1}
li{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
li.active{background:#f0f0f0}

.detail{display:none;color:#555}

#topbar{
 position:fixed;
 bottom:10px;
 left:10px;
}

button{padding:6px 10px;margin:2px}
.edit-on{background:#4caf50;color:#fff}
</style>
</head>

<body>

<div id="imageArea">
<div id="canvas"></div>
<div id="hitWrap"></div>
</div>

<div id="side">

<div id="tabs">
<div class="tab active" id="tabWork">ë‚´ ì‘ì—…</div>
<div class="tab" id="tabTemplates">í…œí”Œë¦¿</div>
</div>

<ul id="list"></ul>
</div>

<div id="topbar">
<button id="editBtn">í¸ì§‘</button>
<button id="imgBtn">ë°°ê²½</button>
<button id="pngBtn">PNG</button>
<button id="exportBtn">JSON</button>
<button id="importBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>

<input type="file" id="imgInput" hidden accept="image/*">
<input type="file" id="jsonInput" hidden accept=".json">
</div>

<script>
let items=[];
let templates=[];
let editMode=false;
let selectedId=null;
let currentTab="work";

const canvas=canvas=document.getElementById("canvas");
const hitWrap=document.getElementById("hitWrap");
const list=document.getElementById("list");

/* ì €ì¥ */
function save(){
 localStorage.setItem("mapData",JSON.stringify(items));
 localStorage.setItem("templates",JSON.stringify(templates));
}
function load(){
 items=JSON.parse(localStorage.getItem("mapData")||"[]");
 templates=JSON.parse(localStorage.getItem("templates")||"[]");
}
load();

/* í¸ì§‘ */
editBtn.onclick=()=>{
 editMode=!editMode;
 editBtn.classList.toggle("edit-on",editMode);
};

/* ë°°ê²½ */
imgBtn.onclick=()=>editMode&&imgInput.click();
imgInput.onchange=e=>{
 const f=e.target.files[0];
 const r=new FileReader();
 r.onload=()=>{
  canvas.style.backgroundImage=`url(${r.result})`;
  localStorage.setItem("bgImg",r.result);
 };
 r.readAsDataURL(f);
};
const bg=localStorage.getItem("bgImg");
if(bg)canvas.style.backgroundImage=`url(${bg})`;

/* íƒ­ */
tabWork.onclick=()=>{
 currentTab="work";
 tabWork.classList.add("active");
 tabTemplates.classList.remove("active");
 render();
};
tabTemplates.onclick=()=>{
 currentTab="templates";
 tabTemplates.classList.add("active");
 tabWork.classList.remove("active");
 render();
};

/* ì„ íƒ */
function select(it){
 selectedId=it.id;
 render();
}

/* ë Œë” */
function render(){
 hitWrap.innerHTML="";
 list.innerHTML="";

 if(currentTab==="templates"){
  templates.forEach((t,i)=>{
   const li=document.createElement("li");
   li.innerText="ğŸ“‚ "+t.name;
   li.onclick=()=>{
    items=t.data;
    save();
    currentTab="work";
    tabWork.onclick();
   };
   list.appendChild(li);
  });
  return;
 }

 items.forEach(it=>{
  /* ë§ˆì»¤ */
  const d=document.createElement("div");
  d.className="hit-area";
  d.style.left=it.x+"%";
  d.style.top=it.y+"%";

  const t=document.createElement("div");
  t.className="hit-title";
  if(it.id===selectedId)t.classList.add("focused");
  t.innerText=it.name;

  t.onclick=e=>{
   e.stopPropagation();
   if(editMode){
    t.contentEditable=true;
    t.focus();
    t.onblur=()=>{
     t.contentEditable=false;
     it.name=t.innerText;
     save();render();
    };
   }else select(it);
  };

  d.appendChild(t);
  hitWrap.appendChild(d);

  /* ë¦¬ìŠ¤íŠ¸ */
  const li=document.createElement("li");
  li.className=it.id===selectedId?"active":"";
  li.innerHTML="<b>"+it.name+"</b>";

  const det=document.createElement("div");
  det.className="detail";
  det.innerText=it.desc;
  if(it.id===selectedId)det.style.display="block";

  det.onclick=e=>{
   e.stopPropagation();
   if(!editMode)return;
   det.contentEditable=true;
   det.focus();
   det.onblur=()=>{
    det.contentEditable=false;
    it.desc=det.innerText;
    save();
   };
  };

  li.onclick=()=>select(it);
  li.appendChild(det);
  list.appendChild(li);
 });
}

/* ì¶”ê°€ */
imageArea.ondblclick=e=>{
 if(!editMode)return;
 const r=imageArea.getBoundingClientRect();
 items.push({
  id:Date.now(),
  name:"í•­ëª©",
  desc:"ì„¤ëª…",
  x:(e.clientX-r.left)/r.width*100,
  y:(e.clientY-r.top)/r.height*100
 });
 save();render();
};

/* PNG ë‚´ë³´ë‚´ê¸° */
pngBtn.onclick=()=>{
 const bgSrc=localStorage.getItem("bgImg");
 if(!bgSrc)return;

 const img=new Image();
 img.src=bgSrc;

 img.onload=()=>{
  const c=document.createElement("canvas");
  c.width=img.width;
  c.height=img.height;
  const ctx=c.getContext("2d");

  ctx.drawImage(img,0,0);

  items.forEach(it=>{
   const x=it.x/100*c.width;
   const y=it.y/100*c.height;

   ctx.fillStyle="#fffdf5";
   ctx.strokeStyle="rgba(0,0,0,.4)";
   ctx.lineWidth=2;

   ctx.beginPath();
   ctx.roundRect(x-50,y-18,100,36,12);
   ctx.fill();
   ctx.stroke();

   ctx.fillStyle="#000";
   ctx.fillText(it.name,x-40,y+5);
  });

  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="map.png";
  a.click();
 };
};

/* JSON */
exportBtn.onclick=()=>{
 const data={
  name:"í…œí”Œë¦¿ "+new Date().toLocaleString(),
  data:items
 };
 const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="map.json";
 a.click();
};

importBtn.onclick=()=>jsonInput.click();

jsonInput.onchange=e=>{
 const f=e.target.files[0];
 const r=new FileReader();
 r.onload=()=>{
  const d=JSON.parse(r.result);
  templates.push(d);
  save();
  alert("í…œí”Œë¦¿ ì €ì¥ë¨!");
 };
 r.readAsText(f);
};

render();
</script>

</body>
</html>