<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

<style>
body{margin:0;font-family:sans-serif;display:flex;height:100vh;overflow:hidden}
#imageArea{flex:8;position:relative;background:#eee}
#canvas{width:100%;height:100%;background-size:contain;background-position:center;background-repeat:no-repeat}
#hitWrap{position:absolute;inset:0}
.hit-area{position:absolute;transform:translate(-50%,-50%);cursor:pointer}
.hit-title{background:yellow;padding:4px 8px;border-radius:12px;white-space:nowrap}

#highlight{position:absolute;border:2px solid red;border-radius:50%;width:60px;height:60px;transform:translate(-50%,-50%);display:none;pointer-events:none}

#side{flex:2;border-left:1px solid #ccc;display:flex;flex-direction:column}
#searchBox{padding:8px;font-size:16px}
ul{list-style:none;margin:0;padding:0;overflow:auto;flex:1}
li{padding:10px;border-bottom:1px solid #eee;position:relative}
li.active{background:#f5f5f5}
.detail{display:none;margin-top:6px;color:#555}
.deleteBtn{position:absolute;right:6px;top:6px;cursor:pointer;color:#000}

#topbar{position:fixed;bottom:10px;left:10px;z-index:5}
button{padding:8px 12px;margin:2px}
.edit-on{background:#4caf50;color:#fff}
</style>
</head>

<body>

<div id="imageArea">
<div id="canvas"></div>
<div id="hitWrap"></div>
<div id="highlight"></div>
</div>

<div id="side">
<input id="searchBox" placeholder="검색">
<ul id="list"></ul>
</div>

<div id="topbar">
<button id="editBtn">편집</button>
<button id="imgBtn">배경</button>
<button id="pngBtn">PNG</button>
<button id="exportBtn">JSON</button>
<button id="importBtn">불러오기</button>
<input type="file" id="imgInput" hidden accept="image/*">
<input type="file" id="jsonInput" hidden accept=".json">
</div>

<script>
let items=[];
let editMode=false;
let selectedId=null;
let longPressTimer=null;

const canvas=document.getElementById("canvas");
const hitWrap=document.getElementById("hitWrap");
const list=document.getElementById("list");
const highlight=document.getElementById("highlight");
const imageArea=document.getElementById("imageArea");

/* 저장 */
function autoSave(){localStorage.setItem("mapData",JSON.stringify(items))}
function loadAuto(){const d=localStorage.getItem("mapData");if(d)items=JSON.parse(d)}
loadAuto();

/* 편집 */
editBtn.onclick=()=>{editMode=!editMode;editBtn.classList.toggle("edit-on",editMode)}

/* 배경 */
imgBtn.onclick=()=>{if(editMode)imgInput.click()}
imgInput.onchange=e=>{
 const f=e.target.files[0];
 const r=new FileReader();
 r.onload=()=>{
  canvas.style.backgroundImage=`url(${r.result})`;
  localStorage.setItem("bgImg",r.result);
 };
 r.readAsDataURL(f);
};
const savedBg=localStorage.getItem("bgImg");
if(savedBg)canvas.style.backgroundImage=`url(${savedBg})`;

/* 선택 */
function clearSel(){
 selectedId=null;
 highlight.style.display="none";
 document.querySelectorAll("li").forEach(li=>li.classList.remove("active"));
 document.querySelectorAll(".detail").forEach(d=>d.style.display="none");
}

function select(it){
 selectedId=it.id;
 highlight.style.display="block";
 highlight.style.left=it.x+"%";
 highlight.style.top=it.y+"%";

 document.querySelectorAll("li").forEach(li=>{
  li.classList.toggle("active",li.dataset.id==it.id);
 });

 document.querySelectorAll(".detail").forEach(d=>d.style.display="none");
 const li=document.querySelector(`li[data-id="${it.id}"]`);
 if(li)li.querySelector(".detail").style.display="block";
}

/* 렌더 */
function render(){
 hitWrap.innerHTML="";
 list.innerHTML="";
 const q=searchBox.value.toLowerCase();

 items.filter(i=>
  i.name.toLowerCase().includes(q)||
  i.desc.toLowerCase().includes(q)
 ).forEach(it=>{

  const d=document.createElement("div");
  d.className="hit-area";
  d.style.left=it.x+"%";
  d.style.top=it.y+"%";

  const t=document.createElement("div");
  t.className="hit-title";
  t.innerText=it.name;

  /* 드래그 */
  let dragging=false;

  t.onpointerdown=e=>{
   if(!editMode)return;
   dragging=true;
  };
  window.onpointermove=e=>{
   if(!dragging)return;
   const r=imageArea.getBoundingClientRect();
   it.x=(e.clientX-r.left)/r.width*100;
   it.y=(e.clientY-r.top)/r.height*100;
   autoSave();render();
  };
  window.onpointerup=()=>dragging=false;

  /* 수정 */
  t.onclick=e=>{
   e.stopPropagation();
   if(editMode){
    t.contentEditable=true;
    t.focus();
    t.onblur=()=>{
     t.contentEditable=false;
     it.name=t.innerText||"이름";
     autoSave();render();
    };
   }else select(it);
  };

  d.appendChild(t);
  hitWrap.appendChild(d);

  /* 리스트 */
  const li=document.createElement("li");
  li.dataset.id=it.id;

  const del=document.createElement("span");
  del.innerText="✕";
  del.className="deleteBtn";
  del.onclick=e=>{
   e.stopPropagation();
   if(!editMode)return;
   items=items.filter(x=>x.id!=it.id);
   autoSave();render();
  };

  const title=document.createElement("b");
  title.innerText=it.name;
  title.onclick=e=>{
   e.stopPropagation();
   if(!editMode)return;
   title.contentEditable=true;
   title.focus();
   title.onblur=()=>{
    title.contentEditable=false;
    it.name=title.innerText;
    autoSave();render();
   };
  };

  const det=document.createElement("div");
  det.className="detail";
  det.innerText=it.desc;
  det.onclick=e=>{
   e.stopPropagation();
   if(!editMode)return;
   det.contentEditable=true;
   det.focus();
   det.onblur=()=>{
    det.contentEditable=false;
    it.desc=det.innerText;
    autoSave();
   };
  };

  li.onclick=e=>{e.stopPropagation();select(it)};
  li.appendChild(del);
  li.appendChild(title);
  li.appendChild(det);
  list.appendChild(li);
 });
}

/* 더블클릭 추가 */
imageArea.ondblclick=e=>{
 if(!editMode)return;
 addItem(e.clientX,e.clientY);
};

/* 길게누르기(모바일) */
imageArea.onpointerdown=e=>{
 if(!editMode)return;
 longPressTimer=setTimeout(()=>{
  addItem(e.clientX,e.clientY);
 },3000);
};
imageArea.onpointerup=()=>clearTimeout(longPressTimer);

function addItem(cx,cy){
 const r=imageArea.getBoundingClientRect();
 items.push({
  id:Date.now(),
  name:"새항목",
  desc:"설명",
  x:(cx-r.left)/r.width*100,
  y:(cy-r.top)/r.height*100
 });
 autoSave();render();
}

/* 배경클릭 해제 */
imageArea.onclick=e=>{
 if(!editMode&&(e.target===imageArea||e.target===canvas))clearSel();
};

searchBox.oninput=render;

/* PNG */
pngBtn.onclick=()=>{
 const c=document.createElement("canvas");
 const ctx=c.getContext("2d");
 const bg=new Image();
 bg.src=localStorage.getItem("bgImg");

 bg.onload=()=>{
  c.width=bg.width;c.height=bg.height;
  ctx.drawImage(bg,0,0);
  items.forEach(it=>{
   ctx.fillStyle="yellow";
   ctx.beginPath();
   ctx.ellipse(it.x/100*c.width,it.y/100*c.height,60,30,0,0,Math.PI*2);
   ctx.fill();
   ctx.fillStyle="black";
   ctx.fillText(it.name,it.x/100*c.width-30,it.y/100*c.height+5);
  });
  const a=document.createElement("a");
  a.href=c.toDataURL();
  a.download="map.png";
  a.click();
 };
};

/* JSON */
exportBtn.onclick=()=>{
 const data={items,bg:localStorage.getItem("bgImg")};
 const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="map.json";
 a.click();
};
importBtn.onclick=()=>jsonInput.click();

jsonInput.onchange=e=>{
 const f=e.target.files[0];
 const r=new FileReader();
 r.onload=()=>{
  const d=JSON.parse(r.result);
  items=d.items||[];
  if(d.bg){
   canvas.style.backgroundImage=`url(${d.bg})`;
   localStorage.setItem("bgImg",d.bg);
  }
  autoSave();render();
 };
 r.readAsText(f);
};

render();
</script>

</body>
</html>