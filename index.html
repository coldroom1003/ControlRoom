<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>공간 네이밍 맵</title>

<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Nanum Pen Script',sans-serif;}
body{margin:0;background:#faf7f2;}

.container{
  display:grid;
  grid-template-columns:7fr 3fr;
  height:100vh;
}

/* 상단 편집모드 배지 */
.mode-badge{
  position:fixed;
  top:10px; left:10px;
  padding:6px 12px;
  background:#ffe066;
  border:2px solid #333;
  display:none;
  z-index:999;
}

/* 그림 영역 */
.image-area{
  position:relative;
  border:2px solid #444;
  background:white;
  overflow:hidden;
  touch-action:none;
}

/* 손그림 배경 */
.sketch-bg{
  position:absolute; inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,0.04),
    rgba(0,0,0,0.04) 1px,
    transparent 2px,
    transparent 6px
  );
}

/* 라벨 */
.hit-area{
  position:absolute;
  transform:translate(-50%,-50%);
}

.hit-title{
  background:#fffdf5;
  border:1px solid #333;
  padding:4px 8px;
  font-size:20px;
  cursor:pointer;
}

.selected .hit-title{
  background:#ffe066;
  border:2px solid #222;
}

/* 하이라이트 */
.highlight{
  position:absolute;
  width:40px;height:26px;
  background:rgba(255,235,59,0.7);
  border-radius:50%;
  transform:translate(-50%,-50%);
  display:none;
}

/* 우측 패널 */
.info-area{
  border-left:2px dashed #aaa;
  padding:10px;
  overflow-y:auto;
}

.top-bar{
  display:flex;
  gap:6px;
  margin-bottom:8px;
}

button{
  font-size:18px;
  cursor:pointer;
}

.edit-on{
  background:#ff7675;
  color:white;
}

.search{
  flex:1;
  padding:6px;
  font-size:18px;
}

li{
  background:#fffdf5;
  margin-bottom:8px;
  padding:8px;
  border:1px solid #ccc;
}

.detail{
  display:none;
  margin-top:6px;
  border-left:4px solid #f4d03f;
  padding-left:6px;
}

/* 모바일 */
@media (max-width:768px){
  .container{
    display:flex;
    flex-direction:column;
  }

  .image-area{
    width:100%;
    height:60vh;
  }

  .info-area{
    border-left:none;
    border-top:2px dashed #aaa;
  }
}
</style>
</head>

<body>

<div id="modeBadge" class="mode-badge">✏️ 편집모드</div>

<div class="container">

  <div class="image-area" id="imageArea">
    <div class="sketch-bg"></div>
    <div id="hitAreas"></div>
    <div id="highlight" class="highlight"></div>
  </div>

  <div class="info-area">
    <div class="top-bar">
      <button id="editBtn">✏️</button>
      <input class="search" placeholder="검색" id="searchBox">
      <button id="addBtn">＋</button>
    </div>
    <ul id="itemList"></ul>
  </div>

</div>

<!-- Panzoom -->
<script src="https://unpkg.com/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyBULBV1bGrUBPE_vi0jGJWsOI1jOh-t1dE",
  authDomain:"sound-control-room.firebaseapp.com",
  projectId:"sound-control-room"
});

const db=firebase.firestore();
const COL=db.collection("items");

/* 상태 */
let items=[];
let editMode=false;

/* 요소 */
const imageArea=document.getElementById("imageArea");
const hitWrap=document.getElementById("hitAreas");
const listEl=document.getElementById("itemList");
const highlight=document.getElementById("highlight");
const badge=document.getElementById("modeBadge");
const editBtn=document.getElementById("editBtn");

/* 편집모드 토글 */
editBtn.onclick=()=>{
  editMode=!editMode;
  editBtn.classList.toggle("edit-on",editMode);
  badge.style.display=editMode?"block":"none";
};

/* 저장 */
function save(item){
  return COL.doc(String(item.id)).set(item);
}

/* 렌더 */
function render(){
  renderHits();
  renderList();
}

function renderHits(){
  hitWrap.innerHTML="";
  items.forEach(it=>{
    const d=document.createElement("div");
    d.className="hit-area";
    d.style.left=it.x+"%";
    d.style.top=it.y+"%";
    d.innerHTML=`<div class="hit-title">${it.name}</div>`;

    d.onclick=e=>{
      e.stopPropagation();
      if(!editMode) select(it);
    };

    enableDrag(d,it);

    hitWrap.appendChild(d);
  });
}

function renderList(){
  listEl.innerHTML="";
  items.forEach(it=>{
    const li=document.createElement("li");
    li.innerHTML=`${it.name}<div class="detail">${it.desc||""}</div>`;
    li.onclick=()=>select(it);
    listEl.appendChild(li);
  });
}

/* 선택 */
function select(it){
  highlight.style.left=it.x+"%";
  highlight.style.top=it.y+"%";
  highlight.style.display="block";

  [...document.querySelectorAll(".detail")].forEach(d=>d.style.display="none");
  listEl.children[items.indexOf(it)].querySelector(".detail").style.display="block";
}

/* 드래그 */
function enableDrag(el,it){
  let drag=false;

  el.onmousedown=e=>{
    if(!editMode) return;
    drag=true;
  };

  window.onmousemove=e=>{
    if(!drag) return;
    const r=imageArea.getBoundingClientRect();
    it.x=((e.clientX-r.left)/r.width)*100;
    it.y=((e.clientY-r.top)/r.height)*100;
    el.style.left=it.x+"%";
    el.style.top=it.y+"%";
  };

  window.onmouseup=()=>{
    if(drag) save(it);
    drag=false;
  };
}

/* 추가 */
function addAt(x,y){
  const it={
    id:Date.now(),
    name:"새 물건",
    x,y,
    desc:""
  };
  items.push(it);
  save(it);
  render();
}

/* 더블클릭 추가 */
imageArea.ondblclick=e=>{
  if(!editMode) return;
  const r=imageArea.getBoundingClientRect();
  addAt(
    (e.clientX-r.left)/r.width*100,
    (e.clientY-r.top)/r.height*100
  );
};

/* 빈공간 선택해제 */
imageArea.onclick=e=>{
  if(editMode) return;
  if(!e.target.closest(".hit-area")){
    highlight.style.display="none";
    [...document.querySelectorAll(".detail")].forEach(d=>d.style.display="none");
  }
};

/* Panzoom */
const panzoom=Panzoom(imageArea,{maxScale:3});
imageArea.parentElement.addEventListener("wheel",panzoom.zoomWithWheel);

/* 불러오기 */
COL.get().then(s=>{
  items=s.docs.map(d=>d.data());
  if(items.length===0){
    addAt(50,50);
  }
  render();
});
</script>

</body>
</html>