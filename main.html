<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ê³µê°„ ë„¤ì´ë° ë§µ</title>

<link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: 'Nanum Pen Script', sans-serif; }

body {
  margin: 0;
  background: #faf7f2;
}

.container {
  display: grid;
  grid-template-columns: 7fr 3fr;
  height: 100vh;
}

/* ê·¸ë¦¼ ì˜ì—­ */
.image-area {
  position: relative;
  margin: 8px;
  min-height: 60vh;
  border: 2px solid #444;
  box-shadow: 3px 3px 0 #aaa;
  background: #fff;
  touch-action: none;
}

/* ì†ê·¸ë¦¼ ë°°ê²½ */
.sketch-bg {
  position: absolute;
  inset: 0;
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(0,0,0,0.04),
      rgba(0,0,0,0.04) 1px,
      transparent 2px,
      transparent 6px
    );
}

/* ë¬¼ê±´ */
.hit-area {
  position: absolute;
  transform: translate(-50%, -50%);
  cursor: pointer;
  user-select: none;
}

.edit-mode .hit-area { cursor: grab; }

/* ìˆ«ì ë¼ë²¨ ì™„ì „ ì œê±° */
.hit-label { display: none; }

/* íƒ€ì´í‹€ ë¼ë²¨ */
.hit-title {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) rotate(-6deg);
  background: #fffdf5;
  border: 1px solid #333;
  padding: 4px 8px;
  font-size: 18px;
  white-space: nowrap;
  box-shadow: 2px 2px 0 #aaa;
  pointer-events: auto;
  transition: transform 0.15s, background 0.15s;
}

/* ë³´ê¸°ëª¨ë“œ hover */
.hit-area:hover .hit-title {
  background: #fff3a0;
  transform: translate(-50%, -50%) rotate(-6deg) scale(1.05);
}

/* í¸ì§‘ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ìš°ì„  */
.edit-mode .hit-title {
  pointer-events: none;
}

/* ì„ íƒëœ ì•„ì´í…œ ê°•ì¡° */
.hit-area.selected .hit-title {
  background: #ffe066;
  border: 2px solid #222;
  box-shadow: 3px 3px 0 #666;
}

/* í•˜ì´ë¼ì´íŠ¸ */
.highlight {
  position: absolute;
  width: 40px;
  height: 26px;
  background: rgba(255, 235, 59, 0.7);
  border-radius: 50%;
  transform: translate(-50%, -50%) rotate(-6deg);
  display: none;
  pointer-events: none;
}

/* ì •ë³´ ì˜ì—­ */
.info-area {
  border-left: 2px dashed #aaa;
  padding: 10px;
  overflow-y: auto;
}

.top-bar {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}

button {
  font-size: 18px;
  cursor: pointer;
}

.search {
  flex: 1;
  padding: 6px;
  font-size: 18px;
}

li {
  background: #fffdf5;
  margin-bottom: 10px;
  padding: 8px;
  border: 1px solid #ccc;
  box-shadow: 2px 2px 0 #bbb;
}

.item-header {
  display: flex;
  justify-content: space-between;
}

.delete-btn { cursor: pointer; }

.detail {
  display: none;
  margin-top: 6px;
  padding-left: 6px;
  border-left: 4px solid #f4d03f;
}

.editable {
  background: #fffbe6;
  border-bottom: 2px dashed #f4d03f;
}

/* ëª¨ë°”ì¼ */
@media (max-width: 768px) {
  .container { flex-direction: column; display: flex; }
  .image-area { height: 45vh; }
}

/* ì¸ì‡„ */
@media print {
  .top-bar, button { display: none; }
  .detail { display: block !important; }
}
</style>
</head>

<body>
<div class="container">

  <div class="image-area" id="imageArea">
    <div class="sketch-bg"></div>
    <div id="hitAreas"></div>
    <div id="highlight" class="highlight"></div>
  </div>

  <div class="info-area">
    <div class="top-bar">
      <button onclick="toggleEditMode()">âœï¸</button>
      <input class="search" placeholder="ì´ë¦„ ê²€ìƒ‰" oninput="filterItems(this.value)">
      <button onclick="addItem()">ï¼‹</button>
    </div>
    <ul id="itemList"></ul>
  </div>

</div>

<script>
const STORAGE_KEY = "space-map-items";
let editMode = false;
let longPressTimer = null;

let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
  { id:1, name:"ì˜ˆì‹œ ë¬¼ê±´", x:50, y:50, description:"ë”ë¸”í´ë¦­ / ê¸¸ê²Œ ëˆŒëŸ¬ ì¶”ê°€" }
];

const listEl = document.getElementById("itemList");
const hitEl = document.getElementById("hitAreas");
const highlightEl = document.getElementById("highlight");
const imageArea = document.getElementById("imageArea");

/* ì €ì¥ */
function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
}

/* í¸ì§‘ëª¨ë“œ */
function toggleEditMode() {
  editMode = !editMode;
  document.body.classList.toggle("edit-mode", editMode);
}

/* ìœ„ì¹˜ ì§€ì • ì¶”ê°€ */
function addItemAtPosition(x, y) {
  const id = Date.now();
  items.push({
    id,
    name: "ìƒˆ ë¬¼ê±´",
    x,
    y,
    description: "ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
  });
  save();
  renderAll();
  selectItem(id);
}

function addItem() {
  addItemAtPosition(50, 50);
}

/* ë¦¬ìŠ¤íŠ¸ */
function renderList(data = items) {
  listEl.innerHTML = "";
  data.forEach(item => {
    const li = document.createElement("li");

    const header = document.createElement("div");
    header.className = "item-header";

    const title = document.createElement("div");
    title.innerText = item.name;
    title.ondblclick = () => editMode && makeEditable(title, v => {
      item.name = v; save(); renderHitAreas();
    });

    const del = document.createElement("span");
    del.className = "delete-btn";
    del.innerText = "ğŸ—‘";
    del.onclick = e => {
      e.stopPropagation();
      deleteItem(item.id);
    };

    header.append(title, del);

    const detail = document.createElement("div");
    detail.className = "detail";
    detail.innerText = item.description;
    detail.ondblclick = () => editMode && makeEditable(detail, v => {
      item.description = v; save();
    });

    li.onclick = () => selectItem(item.id);
    li.append(header, detail);
    listEl.appendChild(li);
  });
}

/* ì‚­ì œ */
function deleteItem(id) {
  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
  items = items.filter(i => i.id !== id);
  save();
  highlightEl.style.display = "none";
  renderAll();
}

/* í¸ì§‘ */
function makeEditable(el, onSave) {
  el.contentEditable = true;
  el.classList.add("editable");
  el.focus();
  el.onblur = finish;
  el.onkeydown = e => {
    if (e.key === "Enter") {
      e.preventDefault();
      finish();
    }
  };
  function finish() {
    el.contentEditable = false;
    el.classList.remove("editable");
    onSave(el.innerText.trim());
  }
}

/* ê·¸ë¦¼ ë Œë” */
function renderHitAreas() {
  hitEl.innerHTML = "";
  items.forEach(item => {
    const d = document.createElement("div");
    d.className = "hit-area";
    d.dataset.id = item.id;
    d.style.left = item.x + "%";
    d.style.top = item.y + "%";
    d.innerHTML = `<div class="hit-title">${item.name}</div>`;
    enableDrag(d, item);
    d.onclick = () => !editMode && selectItem(item.id);
    hitEl.appendChild(d);
  });
}

/* ì„ íƒ */
function selectItem(id) {
  const item = items.find(i => i.id === id);

  document.querySelectorAll(".detail").forEach(d => d.style.display = "none");
  document.querySelectorAll(".hit-area").forEach(h => h.classList.remove("selected"));

  const hit = [...document.querySelectorAll(".hit-area")]
    .find(h => h.dataset.id == id);
  if (hit) hit.classList.add("selected");

  highlightEl.style.left = item.x + "%";
  highlightEl.style.top = item.y + "%";
  highlightEl.style.display = "block";

  const detailEl = listEl.children[items.indexOf(item)].querySelector(".detail");
  detailEl.style.display = "block";
}

/* ë“œë˜ê·¸ */
function enableDrag(el, item) {
  let dragging = false;

  const start = e => {
    if (!editMode) return;
    dragging = true;
    e.preventDefault();
  };

  const move = e => {
    if (!dragging) return;
    const rect = imageArea.getBoundingClientRect();
    const p = e.touches ? e.touches[0] : e;
    item.x = ((p.clientX - rect.left) / rect.width) * 100;
    item.y = ((p.clientY - rect.top) / rect.height) * 100;
    el.style.left = item.x + "%";
    el.style.top = item.y + "%";
    highlightEl.style.left = item.x + "%";
    highlightEl.style.top = item.y + "%";
  };

  const end = () => {
    if (dragging) save();
    dragging = false;
  };

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start);
  window.addEventListener("mousemove", move);
  window.addEventListener("touchmove", move);
  window.addEventListener("mouseup", end);
  window.addEventListener("touchend", end);
}

/* ê²€ìƒ‰ */
function filterItems(v) {
  renderList(items.filter(i => i.name.includes(v)));
}

/* ë”ë¸”í´ë¦­ ì¶”ê°€ */
imageArea.addEventListener("dblclick", e => {
  if (!editMode) return;
  const r = imageArea.getBoundingClientRect();
  addItemAtPosition(
    ((e.clientX - r.left) / r.width) * 100,
    ((e.clientY - r.top) / r.height) * 100
  );
});

/* ëª¨ë°”ì¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì¶”ê°€ */
imageArea.addEventListener("touchstart", e => {
  if (!editMode) return;
  const t = e.touches[0];
  longPressTimer = setTimeout(() => {
    const r = imageArea.getBoundingClientRect();
    addItemAtPosition(
      ((t.clientX - r.left) / r.width) * 100,
      ((t.clientY - r.top) / r.height) * 100
    );
  }, 600);
});

imageArea.addEventListener("touchend", () => clearTimeout(longPressTimer));
imageArea.addEventListener("touchmove", () => clearTimeout(longPressTimer));

/* ë³´ê¸° ëª¨ë“œ ë¹ˆ ê³µê°„ í´ë¦­ â†’ ì„ íƒ í•´ì œ */
imageArea.addEventListener("click", e => {
  if (editMode) return; // í¸ì§‘ëª¨ë“œì—ì„œëŠ” ë¬´ì‹œ
  if (!e.target.closest(".hit-area")) {
    document.querySelectorAll(".hit-area").forEach(h => h.classList.remove("selected"));
    document.querySelectorAll(".detail").forEach(d => d.style.display = "none");
    highlightEl.style.display = "none";
  }
});

function renderAll() {
  renderList();
  renderHitAreas();
}

renderAll();
</script>
</body>
</html>